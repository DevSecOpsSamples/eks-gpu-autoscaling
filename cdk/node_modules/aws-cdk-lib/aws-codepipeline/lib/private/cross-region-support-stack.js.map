{
  "version": 3,
  "sources": ["cross-region-support-stack.ts"],
  "sourcesContent": ["import * as kms from '../../../aws-kms';\nimport * as s3 from '../../../aws-s3';\nimport * as cdk from '../../../core';\nimport { Construct } from 'constructs';\n\nconst REQUIRED_ALIAS_PREFIX = 'alias/';\n\n/**\n * A class needed to work around CodePipeline's extremely small (100 characters)\n * limit for the name/ARN of the key in the ArtifactStore.\n * Limits the length of the alias' auto-generated name to 50 characters.\n */\nclass AliasWithShorterGeneratedName extends kms.Alias {\n  protected generatePhysicalName(): string {\n    let baseName = super.generatePhysicalName();\n    if (baseName.startsWith(REQUIRED_ALIAS_PREFIX)) {\n      // remove the prefix, because we're taking the last characters of the name below\n      baseName = baseName.substring(REQUIRED_ALIAS_PREFIX.length);\n    }\n    const maxLength = 50 - REQUIRED_ALIAS_PREFIX.length;\n    // take the last characters, as they include the hash,\n    // and so have a higher chance of not colliding\n    return REQUIRED_ALIAS_PREFIX + lastNCharacters(baseName, maxLength);\n  }\n}\n\nfunction lastNCharacters(str: string, n: number) {\n  const startIndex = Math.max(str.length - n, 0);\n  return str.substring(startIndex);\n}\n\n/**\n * Props for the support stack\n */\nexport interface CrossRegionSupportConstructProps {\n  /**\n   * Whether to create the KMS CMK\n   *\n   * (Required for cross-account deployments)\n   *\n   * @default true\n   */\n  readonly createKmsKey?: boolean;\n\n  /**\n   * Enables KMS key rotation for cross-account keys.\n   *\n   * @default - false (key rotation is disabled)\n   */\n  readonly enableKeyRotation?: boolean;\n}\n\nexport class CrossRegionSupportConstruct extends Construct {\n  public readonly replicationBucket: s3.IBucket;\n\n  constructor(scope: Construct, id: string, props: CrossRegionSupportConstructProps = {}) {\n    super(scope, id);\n\n    const createKmsKey = props.createKmsKey ?? true;\n\n    let encryptionAlias;\n    if (createKmsKey) {\n      const encryptionKey = new kms.Key(this, 'CrossRegionCodePipelineReplicationBucketEncryptionKey', {\n        removalPolicy: cdk.RemovalPolicy.DESTROY,\n        enableKeyRotation: props.enableKeyRotation,\n      });\n      encryptionAlias = new AliasWithShorterGeneratedName(this, 'CrossRegionCodePipelineReplicationBucketEncryptionAlias', {\n        targetKey: encryptionKey,\n        aliasName: cdk.PhysicalName.GENERATE_IF_NEEDED,\n        removalPolicy: cdk.RemovalPolicy.DESTROY,\n      });\n    }\n    this.replicationBucket = new s3.Bucket(this, 'CrossRegionCodePipelineReplicationBucket', {\n      bucketName: cdk.PhysicalName.GENERATE_IF_NEEDED,\n      encryption: encryptionAlias ? s3.BucketEncryption.KMS : s3.BucketEncryption.KMS_MANAGED,\n      encryptionKey: encryptionAlias,\n      enforceSSL: true,\n      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,\n    });\n  }\n}\n\n/**\n * Construction properties for {@link CrossRegionSupportStack}.\n * This interface is private to the aws-codepipeline package.\n */\nexport interface CrossRegionSupportStackProps {\n  /**\n   * The name of the Stack the Pipeline itself belongs to.\n   * Used to generate a more friendly name for the support Stack.\n   */\n  readonly pipelineStackName: string;\n\n  /**\n   * The AWS region this Stack resides in.\n   */\n  readonly region: string;\n\n  /**\n   * The AWS account ID this Stack belongs to.\n   *\n   * @example '012345678901'\n   */\n  readonly account: string;\n\n  readonly synthesizer: cdk.IStackSynthesizer | undefined;\n\n  /**\n   * Whether or not to create a KMS key in the support stack\n   *\n   * (Required for cross-account deployments)\n   *\n   * @default true\n   */\n  readonly createKmsKey?: boolean;\n\n  /**\n   * Enables KMS key rotation for cross-account keys.\n   *\n   * @default - false (key rotation is disabled)\n   */\n  readonly enableKeyRotation?: boolean;\n}\n\n/**\n * A Stack containing resources required for the cross-region CodePipeline functionality to work.\n * This class is private to the aws-codepipeline package.\n */\nexport class CrossRegionSupportStack extends cdk.Stack {\n  /**\n   * The name of the S3 Bucket used for replicating the Pipeline's artifacts into the region.\n   */\n  public readonly replicationBucket: s3.IBucket;\n\n  constructor(scope: Construct, id: string, props: CrossRegionSupportStackProps) {\n    super(scope, id, {\n      stackName: generateStackName(props),\n      env: {\n        region: props.region,\n        account: props.account,\n      },\n      synthesizer: props.synthesizer,\n    });\n\n    const crossRegionSupportConstruct = new CrossRegionSupportConstruct(this, 'Default', {\n      createKmsKey: props.createKmsKey,\n      enableKeyRotation: props.enableKeyRotation,\n    });\n    this.replicationBucket = crossRegionSupportConstruct.replicationBucket;\n  }\n}\n\nfunction generateStackName(props: CrossRegionSupportStackProps): string {\n  return `${props.pipelineStackName}-support-${props.region}`;\n}\n"],
  "mappings": "+IAAA,KAAA,KAAA,QAAA,kBAAA,EACA,GAAA,QAAA,iBAAA,EACA,IAAA,QAAA,eAAA,EACA,aAAA,QAAA,YAAA,EAEM,sBAAwB,SAO9B,MAAM,qCAAsC,KAAI,KAAK,CACzC,sBAAoB,CAC5B,GAAI,UAAW,MAAM,qBAAoB,EACzC,AAAI,SAAS,WAAW,qBAAqB,GAE3C,UAAW,SAAS,UAAU,sBAAsB,MAAM,GAE5D,KAAM,WAAY,GAAK,sBAAsB,OAG7C,MAAO,uBAAwB,gBAAgB,SAAU,SAAS,GAItE,yBAAyB,IAAa,EAAS,CAC7C,KAAM,YAAa,KAAK,IAAI,IAAI,OAAS,EAAG,CAAC,EAC7C,MAAO,KAAI,UAAU,UAAU,CACjC,CAuBA,MAAa,mCAAoC,cAAA,SAAS,CAGxD,YAAY,MAAkB,GAAY,MAA0C,CAAA,EAAE,QACpF,MAAM,MAAO,EAAE,EAEf,KAAM,cAAY,IAAG,MAAM,gBAAY,MAAA,KAAA,OAAA,GAAI,GAE3C,GAAI,iBACJ,GAAI,aAAc,CAChB,KAAM,eAAgB,GAAI,KAAI,IAAI,KAAM,wDAAyD,CAC/F,cAAe,IAAI,cAAc,QACjC,kBAAmB,MAAM,kBAC1B,EACD,gBAAkB,GAAI,+BAA8B,KAAM,0DAA2D,CACnH,UAAW,cACX,UAAW,IAAI,aAAa,mBAC5B,cAAe,IAAI,cAAc,QAClC,EAEH,KAAK,kBAAoB,GAAI,IAAG,OAAO,KAAM,2CAA4C,CACvF,WAAY,IAAI,aAAa,mBAC7B,WAAY,gBAAkB,GAAG,iBAAiB,IAAM,GAAG,iBAAiB,YAC5E,cAAe,gBACf,WAAY,GACZ,kBAAmB,GAAG,kBAAkB,UACzC,GA1BL,QAAA,4BAAA,4BA4EA,MAAa,+BAAgC,KAAI,KAAK,CAMpD,YAAY,MAAkB,GAAY,MAAmC,CAC3E,MAAM,MAAO,GAAI,CACf,UAAW,kBAAkB,KAAK,EAClC,IAAK,CACH,OAAQ,MAAM,OACd,QAAS,MAAM,SAEjB,YAAa,MAAM,YACpB,EAED,KAAM,6BAA8B,GAAI,6BAA4B,KAAM,UAAW,CACnF,aAAc,MAAM,aACpB,kBAAmB,MAAM,kBAC1B,EACD,KAAK,kBAAoB,4BAA4B,mBApBzD,QAAA,wBAAA,wBAwBA,2BAA2B,MAAmC,CAC5D,MAAO,GAAG,MAAM,6BAA6B,MAAM,QACrD",
  "names": []
}
