"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.normalizeStatement=exports.PostProcessPolicyDocument=void 0;const cdk=require("../../../core"),util_1=require("../util"),merge_statements_1=require("./merge-statements");class PostProcessPolicyDocument{constructor(autoAssignSids,minimize){this.autoAssignSids=autoAssignSids,this.minimize=minimize}postProcess(input,_context){if(!input||!input.Statement)return input;this.minimize&&(input.Statement=merge_statements_1.mergeStatements(input.Statement));const jsonStatements=new Set,uniqueStatements=[];for(const statement of input.Statement){const jsonStatement=JSON.stringify(statement);jsonStatements.has(jsonStatement)||(uniqueStatements.push(statement),jsonStatements.add(jsonStatement))}const statements=uniqueStatements.map((s,i)=>(this.autoAssignSids&&!s.Sid&&(s.Sid=i.toString()),s));return{...input,Statement:statements}}}exports.PostProcessPolicyDocument=PostProcessPolicyDocument;function normalizeStatement(s){return noUndef({Action:_norm(s.Action,{unique:!0}),NotAction:_norm(s.NotAction,{unique:!0}),Condition:_norm(s.Condition),Effect:_norm(s.Effect),Principal:_normPrincipal(s.Principal),NotPrincipal:_normPrincipal(s.NotPrincipal),Resource:_norm(s.Resource,{unique:!0}),NotResource:_norm(s.NotResource,{unique:!0}),Sid:_norm(s.Sid)});function _norm(values,{unique=!1}={unique:!1}){if(values!=null){if(cdk.Token.isUnresolved(values))return values;if(Array.isArray(values))return!values||values.length===0?void 0:values.length===1?values[0]:unique?Array.from(new Set(values)):values;if(!(values&&typeof values=="object"&&Object.keys(values).length===0))return values}}function _normPrincipal(principal){if(!principal)return;const keys=Object.keys(principal);if(keys.length===0)return;if(util_1.LITERAL_STRING_KEY in principal)return principal[util_1.LITERAL_STRING_KEY][0];const result={};for(const key of keys){const normVal=_norm(principal[key]);normVal&&(result[key]=normVal)}return result}}exports.normalizeStatement=normalizeStatement;function noUndef(x){const ret={};for(const[key,value]of Object.entries(x))value!==void 0&&(ret[key]=value);return ret}
//# sourceMappingURL=postprocess-policy-document.js.map
