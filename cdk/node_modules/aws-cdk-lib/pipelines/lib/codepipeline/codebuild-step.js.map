{
  "version": 3,
  "sources": ["codebuild-step.ts"],
  "sourcesContent": ["import * as codebuild from '../../../aws-codebuild';\nimport * as ec2 from '../../../aws-ec2';\nimport * as iam from '../../../aws-iam';\nimport { Duration } from '../../../core';\nimport { ShellStep, ShellStepProps } from '../blueprint';\nimport { mergeBuildSpecs } from './private/buildspecs';\nimport { makeCodePipelineOutput } from './private/outputs';\n\n/**\n * Construction props for a CodeBuildStep\n */\nexport interface CodeBuildStepProps extends ShellStepProps {\n  /**\n   * Name for the generated CodeBuild project\n   *\n   * @default - Automatically generated\n   */\n  readonly projectName?: string;\n\n  /**\n   * Additional configuration that can only be configured via BuildSpec\n   *\n   * You should not use this to specify output artifacts; those\n   * should be supplied via the other properties of this class, otherwise\n   * CDK Pipelines won't be able to inspect the artifacts.\n   *\n   * Set the `commands` to an empty array if you want to fully specify\n   * the BuildSpec using this field.\n   *\n   * The BuildSpec must be available inline--it cannot reference a file\n   * on disk.\n   *\n   * @default - BuildSpec completely derived from other properties\n   */\n  readonly partialBuildSpec?: codebuild.BuildSpec;\n\n  /**\n   * The VPC where to execute the SimpleSynth.\n   *\n   * @default - No VPC\n   */\n  readonly vpc?: ec2.IVpc;\n\n  /**\n   * Which subnets to use.\n   *\n   * Only used if 'vpc' is supplied.\n   *\n   * @default - All private subnets.\n   */\n  readonly subnetSelection?: ec2.SubnetSelection;\n\n  /**\n   * Policy statements to add to role used during the synth\n   *\n   * Can be used to add acces to a CodeArtifact repository etc.\n   *\n   * @default - No policy statements added to CodeBuild Project Role\n   */\n  readonly rolePolicyStatements?: iam.PolicyStatement[];\n\n  /**\n   * Custom execution role to be used for the CodeBuild project\n   *\n   * @default - A role is automatically created\n   */\n  readonly role?: iam.IRole;\n\n  /**\n   * Changes to environment\n   *\n   * This environment will be combined with the pipeline's default\n   * environment.\n   *\n   * @default - Use the pipeline's default build environment\n   */\n  readonly buildEnvironment?: codebuild.BuildEnvironment;\n\n  /**\n   * Which security group to associate with the script's project network interfaces.\n   * If no security group is identified, one will be created automatically.\n   *\n   * Only used if 'vpc' is supplied.\n   *\n   * @default - Security group will be automatically created.\n   */\n  readonly securityGroups?: ec2.ISecurityGroup[];\n\n  /**\n   * The number of minutes after which AWS CodeBuild stops the build if it's\n   * not complete. For valid values, see the timeoutInMinutes field in the AWS\n   * CodeBuild User Guide.\n   *\n   * @default Duration.hours(1)\n   */\n  readonly timeout?: Duration;\n}\n\n/**\n * Run a script as a CodeBuild Project\n *\n * The BuildSpec must be available inline--it cannot reference a file\n * on disk. If your current build instructions are in a file like\n * `buildspec.yml` in your repository, extract them to a script\n * (say, `build.sh`) and invoke that script as part of the build:\n *\n * ```ts\n * new pipelines.CodeBuildStep('Synth', {\n *   commands: ['./build.sh'],\n * });\n * ```\n */\nexport class CodeBuildStep extends ShellStep {\n  /**\n   * Name for the generated CodeBuild project\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  public readonly projectName?: string;\n\n  /**\n   * The VPC where to execute the SimpleSynth.\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  public readonly vpc?: ec2.IVpc;\n\n  /**\n   * Which subnets to use.\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  public readonly subnetSelection?: ec2.SubnetSelection;\n\n  /**\n   * Policy statements to add to role used during the synth\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  public readonly rolePolicyStatements?: iam.PolicyStatement[];\n\n  /**\n   * Custom execution role to be used for the CodeBuild project\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  public readonly role?: iam.IRole;\n\n  /**\n   * Build environment\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  readonly buildEnvironment?: codebuild.BuildEnvironment;\n\n  /**\n   * Which security group to associate with the script's project network interfaces.\n   *\n   * @default - No value specified at construction time, use defaults\n   */\n  readonly securityGroups?: ec2.ISecurityGroup[];\n\n  /**\n   * The number of minutes after which AWS CodeBuild stops the build if it's\n   * not complete. For valid values, see the timeoutInMinutes field in the AWS\n   * CodeBuild User Guide.\n   *\n   * @default Duration.hours(1)\n   */\n  readonly timeout?: Duration;\n\n  private _project?: codebuild.IProject;\n  private _partialBuildSpec?: codebuild.BuildSpec;\n  private readonly exportedVariables = new Set<string>();\n  private exportedVarsRendered = false;\n\n  constructor(id: string, props: CodeBuildStepProps) {\n    super(id, props);\n\n    this.projectName = props.projectName;\n    this.buildEnvironment = props.buildEnvironment;\n    this._partialBuildSpec = props.partialBuildSpec;\n    this.vpc = props.vpc;\n    this.subnetSelection = props.subnetSelection;\n    this.role = props.role;\n    this.rolePolicyStatements = props.rolePolicyStatements;\n    this.securityGroups = props.securityGroups;\n    this.timeout = props.timeout;\n  }\n\n  /**\n   * CodeBuild Project generated for the pipeline\n   *\n   * Will only be available after the pipeline has been built.\n   */\n  public get project(): codebuild.IProject {\n    if (!this._project) {\n      throw new Error('Call pipeline.buildPipeline() before reading this property');\n    }\n    return this._project;\n  }\n\n  /**\n   * The CodeBuild Project's principal\n   */\n  public get grantPrincipal(): iam.IPrincipal {\n    return this.project.grantPrincipal;\n  }\n\n  /**\n   * Additional configuration that can only be configured via BuildSpec\n   *\n   * Contains exported variables\n   *\n   * @default - Contains the exported variables\n   */\n  public get partialBuildSpec(): codebuild.BuildSpec | undefined {\n    this.exportedVarsRendered = true;\n\n    const varsBuildSpec = this.exportedVariables.size > 0 ? codebuild.BuildSpec.fromObject({\n      version: '0.2',\n      env: {\n        'exported-variables': Array.from(this.exportedVariables),\n      },\n    }) : undefined;\n\n    return mergeBuildSpecs(varsBuildSpec, this._partialBuildSpec);\n  }\n\n  /**\n   * Reference a CodePipeline variable defined by the CodeBuildStep.\n   *\n   * The variable must be set in the shell of the CodeBuild step when\n   * it finishes its `post_build` phase.\n   *\n   * @param variableName the name of the variable for reference.\n   * @example\n   * // Access the output of one CodeBuildStep in another CodeBuildStep\n   * declare const pipeline: pipelines.CodePipeline;\n   *\n   * const step1 = new pipelines.CodeBuildStep('Step1', {\n   *   commands: ['export MY_VAR=hello'],\n   * });\n   *\n   * const step2 = new pipelines.CodeBuildStep('Step2', {\n   *   env: {\n   *     IMPORTED_VAR: step1.exportedVariable('MY_VAR'),\n   *   },\n   *   commands: ['echo $IMPORTED_VAR'],\n   * });\n   */\n  public exportedVariable(variableName: string): string {\n    if (this.exportedVarsRendered && !this.exportedVariables.has(variableName)) {\n      throw new Error('exportVariable(): Pipeline has already been produced, cannot call this function anymore');\n    }\n\n    this.exportedVariables.add(variableName);\n\n    return makeCodePipelineOutput(this, variableName);\n  }\n\n  /**\n   * Set the internal project value\n   *\n   * @internal\n   */\n  public _setProject(project: codebuild.IProject) {\n    this._project = project;\n  }\n}\n"],
  "mappings": "uNAAA,UAAA,QAAA,wBAAA,EAIA,YAAA,QAAA,cAAA,EACA,aAAA,QAAA,sBAAA,EACA,UAAA,QAAA,mBAAA,EA0GA,MAAa,qBAAsB,aAAA,SAAS,CAgE1C,YAAY,GAAY,MAAyB,CAC/C,MAAM,GAAI,KAAK,EAJA,KAAA,kBAAoB,GAAI,KACjC,KAAA,qBAAuB,2EAK7B,KAAK,YAAc,MAAM,YACzB,KAAK,iBAAmB,MAAM,iBAC9B,KAAK,kBAAoB,MAAM,iBAC/B,KAAK,IAAM,MAAM,IACjB,KAAK,gBAAkB,MAAM,gBAC7B,KAAK,KAAO,MAAM,KAClB,KAAK,qBAAuB,MAAM,qBAClC,KAAK,eAAiB,MAAM,eAC5B,KAAK,QAAU,MAAM,WAQZ,UAAO,CAChB,GAAI,CAAC,KAAK,SACR,KAAM,IAAI,OAAM,4DAA4D,EAE9E,MAAO,MAAK,YAMH,iBAAc,CACvB,MAAO,MAAK,QAAQ,kBAUX,mBAAgB,CACzB,KAAK,qBAAuB,GAE5B,KAAM,eAAgB,KAAK,kBAAkB,KAAO,EAAI,UAAU,UAAU,WAAW,CACrF,QAAS,MACT,IAAK,CACH,qBAAsB,MAAM,KAAK,KAAK,iBAAiB,GAE1D,EAAI,OAEL,MAAO,cAAA,gBAAgB,cAAe,KAAK,iBAAiB,EAyBvD,iBAAiB,aAAoB,CAC1C,GAAI,KAAK,sBAAwB,CAAC,KAAK,kBAAkB,IAAI,YAAY,EACvE,KAAM,IAAI,OAAM,yFAAyF,EAG3G,YAAK,kBAAkB,IAAI,YAAY,EAEhC,UAAA,uBAAuB,KAAM,YAAY,EAQ3C,YAAY,QAA2B,CAC5C,KAAK,SAAW,SA3JpB,QAAA,cAAA",
  "names": []
}
