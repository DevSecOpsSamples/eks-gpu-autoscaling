{
  "version": 3,
  "sources": ["confirm-permissions-broadening.ts"],
  "sourcesContent": ["import { IStage } from '../../../aws-codepipeline';\nimport * as cpa from '../../../aws-codepipeline-actions';\nimport * as sns from '../../../aws-sns';\nimport { Stage } from '../../../core';\nimport { Node } from 'constructs';\nimport { Step } from '../blueprint';\nimport { ApplicationSecurityCheck } from '../private/application-security-check';\nimport { CodePipeline } from './codepipeline';\nimport { CodePipelineActionFactoryResult, ICodePipelineActionFactory, ProduceActionOptions } from './codepipeline-action-factory';\n\n/**\n * Properties for a `PermissionsBroadeningCheck`\n */\nexport interface PermissionsBroadeningCheckProps {\n  /**\n   * The CDK Stage object to check the stacks of\n   *\n   * This should be the same Stage object you are passing to `addStage()`.\n   */\n  readonly stage: Stage;\n\n  /**\n   * Topic to send notifications when a human needs to give manual confirmation\n   *\n   * @default - no notification\n   */\n  readonly notificationTopic?: sns.ITopic\n}\n\n/**\n * Pause the pipeline if a deployment would add IAM permissions or Security Group rules\n *\n * This step is only supported in CodePipeline pipelines.\n */\nexport class ConfirmPermissionsBroadening extends Step implements ICodePipelineActionFactory {\n  constructor(id: string, private readonly props: PermissionsBroadeningCheckProps) {\n    super(id);\n  }\n\n  public produceAction(stage: IStage, options: ProduceActionOptions): CodePipelineActionFactoryResult {\n    const sec = this.getOrCreateSecCheck(options.pipeline);\n    this.props.notificationTopic?.grantPublish(sec.cdkDiffProject);\n\n    const variablesNamespace = Node.of(this.props.stage).addr;\n\n    const approveActionName = `${options.actionName}.Confirm`;\n    stage.addAction(new cpa.CodeBuildAction({\n      runOrder: options.runOrder,\n      actionName: `${options.actionName}.Check`,\n      input: options.artifacts.toCodePipeline(options.pipeline.cloudAssemblyFileSet),\n      project: sec.cdkDiffProject,\n      variablesNamespace,\n      environmentVariables: {\n        STAGE_PATH: { value: Node.of(this.props.stage).path },\n        STAGE_NAME: { value: stage.stageName },\n        ACTION_NAME: { value: approveActionName },\n        ...this.props.notificationTopic ? {\n          NOTIFICATION_ARN: { value: this.props.notificationTopic.topicArn },\n          NOTIFICATION_SUBJECT: { value: `Confirm permission broadening in ${this.props.stage.stageName}` },\n        } : {},\n      },\n    }));\n\n    stage.addAction(new cpa.ManualApprovalAction({\n      actionName: approveActionName,\n      runOrder: options.runOrder + 1,\n      additionalInformation: `#{${variablesNamespace}.MESSAGE}`,\n      externalEntityLink: `#{${variablesNamespace}.LINK}`,\n    }));\n\n    return { runOrdersConsumed: 2 };\n  }\n\n  private getOrCreateSecCheck(pipeline: CodePipeline): ApplicationSecurityCheck {\n    const id = 'PipelinesSecurityCheck';\n    const existing = Node.of(pipeline).tryFindChild(id);\n    if (existing) {\n      if (!(existing instanceof ApplicationSecurityCheck)) {\n        throw new Error(`Expected '${Node.of(existing).path}' to be 'ApplicationSecurityCheck' but was '${existing}'`);\n      }\n      return existing;\n    }\n\n    return new ApplicationSecurityCheck(pipeline, id, {\n      codePipeline: pipeline.pipeline,\n    });\n  }\n}"],
  "mappings": "sOACA,IAAA,QAAA,mCAAA,EAGA,aAAA,QAAA,YAAA,EACA,YAAA,QAAA,cAAA,EACA,6BAAA,QAAA,uCAAA,EA4BA,MAAa,oCAAqC,aAAA,IAAI,CACpD,YAAY,GAA6B,MAAsC,CAC7E,MAAM,EAAE,EAD+B,KAAA,MAAA,2FAIlC,cAAc,MAAe,QAA6B,uJAC/D,KAAM,KAAM,KAAK,oBAAoB,QAAQ,QAAQ,EACrD,AAAA,IAAA,KAAK,MAAM,qBAAiB,MAAA,KAAA,QAAA,GAAE,aAAa,IAAI,cAAc,EAE7D,KAAM,oBAAqB,aAAA,KAAK,GAAG,KAAK,MAAM,KAAK,EAAE,KAE/C,kBAAoB,GAAG,QAAQ,qBACrC,aAAM,UAAU,GAAI,KAAI,gBAAgB,CACtC,SAAU,QAAQ,SAClB,WAAY,GAAG,QAAQ,mBACvB,MAAO,QAAQ,UAAU,eAAe,QAAQ,SAAS,oBAAoB,EAC7E,QAAS,IAAI,eACb,mBACA,qBAAsB,CACpB,WAAY,CAAE,MAAO,aAAA,KAAK,GAAG,KAAK,MAAM,KAAK,EAAE,IAAI,EACnD,WAAY,CAAE,MAAO,MAAM,SAAS,EACpC,YAAa,CAAE,MAAO,iBAAiB,KACpC,KAAK,MAAM,kBAAoB,CAChC,iBAAkB,CAAE,MAAO,KAAK,MAAM,kBAAkB,QAAQ,EAChE,qBAAsB,CAAE,MAAO,oCAAoC,KAAK,MAAM,MAAM,WAAW,GAC7F,CAAA,GAEP,CAAC,EAEF,MAAM,UAAU,GAAI,KAAI,qBAAqB,CAC3C,WAAY,kBACZ,SAAU,QAAQ,SAAW,EAC7B,sBAAuB,KAAK,8BAC5B,mBAAoB,KAAK,2BAC1B,CAAC,EAEK,CAAE,kBAAmB,CAAC,EAGvB,oBAAoB,SAAsB,CAChD,KAAM,IAAK,yBACL,SAAW,aAAA,KAAK,GAAG,QAAQ,EAAE,aAAa,EAAE,EAClD,GAAI,SAAU,CACZ,GAAI,CAAE,oBAAoB,8BAAA,0BACxB,KAAM,IAAI,OAAM,aAAa,aAAA,KAAK,GAAG,QAAQ,EAAE,mDAAmD,WAAW,EAE/G,MAAO,UAGT,MAAO,IAAI,8BAAA,yBAAyB,SAAU,GAAI,CAChD,aAAc,SAAS,SACxB,GAnDL,QAAA,6BAAA",
  "names": []
}
