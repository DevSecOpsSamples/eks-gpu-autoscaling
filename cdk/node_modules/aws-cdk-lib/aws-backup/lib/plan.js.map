{
  "version": 3,
  "sources": ["plan.ts"],
  "sourcesContent": ["import { IResource, Lazy, Resource } from '../../core';\nimport { Construct } from 'constructs';\nimport { CfnBackupPlan } from './backup.generated';\nimport { BackupPlanRule } from './rule';\nimport { BackupSelection, BackupSelectionOptions } from './selection';\nimport { BackupVault, IBackupVault } from './vault';\n\n/**\n * A backup plan\n */\nexport interface IBackupPlan extends IResource {\n  /**\n   * The identifier of the backup plan.\n   *\n   * @attribute\n   */\n  readonly backupPlanId: string;\n}\n\n/**\n * Properties for a BackupPlan\n */\nexport interface BackupPlanProps {\n  /**\n   * The display name of the backup plan.\n   *\n   * @default - A CDK generated name\n   */\n  readonly backupPlanName?: string;\n\n  /**\n   * The backup vault where backups are stored\n   *\n   * @default - use the vault defined at the rule level. If not defined a new\n   * common vault for the plan will be created\n   */\n  readonly backupVault?: IBackupVault;\n\n  /**\n   * Rules for the backup plan. Use `addRule()` to add rules after\n   * instantiation.\n   *\n   * @default - use `addRule()` to add rules\n   */\n  readonly backupPlanRules?: BackupPlanRule[];\n\n  /**\n   * Enable Windows VSS backup.\n   *\n   * @see https://docs.aws.amazon.com/aws-backup/latest/devguide/windows-backups.html\n   *\n   * @default false\n   */\n  readonly windowsVss?: boolean;\n}\n\n/**\n * A backup plan\n */\nexport class BackupPlan extends Resource implements IBackupPlan {\n  /**\n   * Import an existing backup plan\n   */\n  public static fromBackupPlanId(scope: Construct, id: string, backupPlanId: string): IBackupPlan {\n    class Import extends Resource implements IBackupPlan {\n      public readonly backupPlanId = backupPlanId;\n    }\n    return new Import(scope, id);\n  }\n\n  /**\n   * Daily with 35 day retention\n   */\n  public static daily35DayRetention(scope: Construct, id: string, backupVault?: IBackupVault) {\n    const plan = new BackupPlan(scope, id, { backupVault });\n    plan.addRule(BackupPlanRule.daily());\n    return plan;\n  }\n\n  /**\n   * Daily and monthly with 1 year retention\n   */\n  public static dailyMonthly1YearRetention(scope: Construct, id: string, backupVault?: IBackupVault) {\n    const plan = new BackupPlan(scope, id, { backupVault });\n    plan.addRule(BackupPlanRule.daily());\n    plan.addRule(BackupPlanRule.monthly1Year());\n    return plan;\n  }\n\n  /**\n   * Daily, weekly and monthly with 5 year retention\n   */\n  public static dailyWeeklyMonthly5YearRetention(scope: Construct, id: string, backupVault?: IBackupVault) {\n    const plan = new BackupPlan(scope, id, { backupVault });\n    plan.addRule(BackupPlanRule.daily());\n    plan.addRule(BackupPlanRule.weekly());\n    plan.addRule(BackupPlanRule.monthly5Year());\n    return plan;\n  }\n\n  /**\n   * Daily, weekly and monthly with 7 year retention\n   */\n  public static dailyWeeklyMonthly7YearRetention(scope: Construct, id: string, backupVault?: IBackupVault) {\n    const plan = new BackupPlan(scope, id, { backupVault });\n    plan.addRule(BackupPlanRule.daily());\n    plan.addRule(BackupPlanRule.weekly());\n    plan.addRule(BackupPlanRule.monthly7Year());\n    return plan;\n  }\n\n  public readonly backupPlanId: string;\n\n  /**\n   * The ARN of the backup plan\n   *\n   * @attribute\n   */\n  public readonly backupPlanArn: string;\n\n  /**\n   * Version Id\n   *\n   * @attribute\n   */\n  public readonly versionId: string;\n\n  private readonly rules: CfnBackupPlan.BackupRuleResourceTypeProperty[] = [];\n  private _backupVault?: IBackupVault;\n\n  constructor(scope: Construct, id: string, props: BackupPlanProps = {}) {\n    super(scope, id);\n\n    const plan = new CfnBackupPlan(this, 'Resource', {\n      backupPlan: {\n        advancedBackupSettings: this.advancedBackupSettings(props),\n        backupPlanName: props.backupPlanName || id,\n        backupPlanRule: Lazy.any({ produce: () => this.rules }, { omitEmptyArray: true }),\n      },\n    });\n\n    this.backupPlanId = plan.attrBackupPlanId;\n    this.backupPlanArn = plan.attrBackupPlanArn;\n    this.versionId = plan.attrVersionId;\n\n    this._backupVault = props.backupVault;\n\n    for (const rule of props.backupPlanRules || []) {\n      this.addRule(rule);\n    }\n\n    this.node.addValidation({ validate: () => this.validatePlan() });\n  }\n\n  private advancedBackupSettings(props: BackupPlanProps) {\n    if (!props.windowsVss) {\n      return undefined;\n    }\n    return [{\n      backupOptions: {\n        WindowsVSS: 'enabled',\n      },\n      resourceType: 'EC2',\n    }];\n  }\n\n  /**\n   * Adds a rule to a plan\n   *\n   * @param rule the rule to add\n   */\n  public addRule(rule: BackupPlanRule) {\n    let vault: IBackupVault;\n    if (rule.props.backupVault) {\n      vault = rule.props.backupVault;\n    } else if (this._backupVault) {\n      vault = this._backupVault;\n    } else {\n      this._backupVault = new BackupVault(this, 'Vault');\n      vault = this._backupVault;\n    }\n\n    this.rules.push({\n      completionWindowMinutes: rule.props.completionWindow?.toMinutes(),\n      lifecycle: (rule.props.deleteAfter || rule.props.moveToColdStorageAfter) && {\n        deleteAfterDays: rule.props.deleteAfter?.toDays(),\n        moveToColdStorageAfterDays: rule.props.moveToColdStorageAfter?.toDays(),\n      },\n      ruleName: rule.props.ruleName ?? `${this.node.id}Rule${this.rules.length}`,\n      scheduleExpression: rule.props.scheduleExpression?.expressionString,\n      startWindowMinutes: rule.props.startWindow?.toMinutes(),\n      enableContinuousBackup: rule.props.enableContinuousBackup,\n      targetBackupVault: vault.backupVaultName,\n    });\n  }\n\n  /**\n   * The backup vault where backups are stored if not defined at\n   * the rule level\n   */\n  public get backupVault(): IBackupVault {\n    if (!this._backupVault) {\n      // This cannot happen but is here to make TypeScript happy\n      throw new Error('No backup vault!');\n    }\n\n    return this._backupVault;\n  }\n\n  /**\n   * Adds a selection to this plan\n   */\n  public addSelection(id: string, options: BackupSelectionOptions): BackupSelection {\n    return new BackupSelection(this, id, {\n      backupPlan: this,\n      ...options,\n    });\n  }\n\n  private validatePlan() {\n    if (this.rules.length === 0) {\n      return ['A backup plan must have at least 1 rule.'];\n    }\n\n    return [];\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
