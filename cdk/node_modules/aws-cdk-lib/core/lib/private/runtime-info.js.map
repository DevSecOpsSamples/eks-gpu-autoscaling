{
  "version": 3,
  "sources": ["runtime-info.ts"],
  "sourcesContent": ["import { IConstruct } from 'constructs';\nimport { Stack } from '../stack';\nimport { Stage } from '../stage';\n\nconst ALLOWED_FQN_PREFIXES = [\n  // SCOPES\n  '@aws-cdk/', '@aws-cdk-containers/', '@aws-solutions-konstruk/', '@aws-solutions-constructs/', '@amzn/',\n  // PACKAGES\n  'aws-rfdk.', 'aws-cdk-lib.', 'monocdk.',\n];\n\n/**\n * Symbol for accessing jsii runtime information\n *\n * Introduced in jsii 1.19.0, cdk 1.90.0.\n */\nconst JSII_RUNTIME_SYMBOL = Symbol.for('jsii.rtti');\n\n/**\n * Source information on a construct (class fqn and version)\n */\nexport interface ConstructInfo {\n  readonly fqn: string;\n  readonly version: string;\n}\n\nexport function constructInfoFromConstruct(construct: IConstruct): ConstructInfo | undefined {\n  const jsiiRuntimeInfo = Object.getPrototypeOf(construct).constructor[JSII_RUNTIME_SYMBOL];\n  if (typeof jsiiRuntimeInfo === 'object'\n    && jsiiRuntimeInfo !== null\n    && typeof jsiiRuntimeInfo.fqn === 'string'\n    && typeof jsiiRuntimeInfo.version === 'string') {\n    return { fqn: jsiiRuntimeInfo.fqn, version: jsiiRuntimeInfo.version };\n  } else if (jsiiRuntimeInfo) {\n    // There is something defined, but doesn't match our expectations. Fail fast and hard.\n    throw new Error(`malformed jsii runtime info for construct: '${construct.node.path}'`);\n  }\n  return undefined;\n}\n\n/**\n * For a given stack, walks the tree and finds the runtime info for all constructs within the tree.\n * Returns the unique list of construct info present in the stack,\n * as long as the construct fully-qualified names match the defined allow list.\n */\nexport function constructInfoFromStack(stack: Stack): ConstructInfo[] {\n  const isDefined = (value: ConstructInfo | undefined): value is ConstructInfo => value !== undefined;\n\n  const allConstructInfos = constructsInStack(stack)\n    .map(construct => constructInfoFromConstruct(construct))\n    .filter(isDefined)\n    .filter(info => ALLOWED_FQN_PREFIXES.find(prefix => info.fqn.startsWith(prefix)));\n\n  // Adds the jsii runtime as a psuedo construct for reporting purposes.\n  allConstructInfos.push({\n    fqn: 'jsii-runtime.Runtime',\n    version: getJsiiAgentVersion(),\n  });\n\n  // Filter out duplicate values\n  const uniqKeys = new Set();\n  return allConstructInfos.filter(construct => {\n    const constructKey = `${construct.fqn}@${construct.version}`;\n    const isDuplicate = uniqKeys.has(constructKey);\n    uniqKeys.add(constructKey);\n    return !isDuplicate;\n  });\n}\n\n/**\n * Returns all constructs under the parent construct (including the parent),\n * stopping when it reaches a boundary of another stack (e.g., Stack, Stage, NestedStack).\n */\nfunction constructsInStack(construct: IConstruct): IConstruct[] {\n  const constructs = [construct];\n  construct.node.children\n    .filter(child => !Stage.isStage(child) && !Stack.isStack(child))\n    .forEach(child => constructs.push(...constructsInStack(child)));\n  return constructs;\n}\n\nfunction getJsiiAgentVersion() {\n  let jsiiAgent = process.env.JSII_AGENT;\n\n  // if JSII_AGENT is not specified, we will assume this is a node.js runtime\n  // and plug in our node.js version\n  if (!jsiiAgent) {\n    jsiiAgent = `node.js/${process.version}`;\n  }\n\n  // Sanitize the agent to remove characters which might mess with the downstream\n  // prefix encoding & decoding. In particular the .NET jsii agent takes a form like:\n  // DotNet/5.0.3/.NETCoreApp,Version=v3.1/1.0.0.0\n  // The `,` in the above messes with the prefix decoding when reporting the analytics.\n  jsiiAgent = jsiiAgent.replace(/[^a-z0-9.-/=_]/gi, '-');\n\n  return jsiiAgent;\n}\n"],
  "mappings": "6IACA,KAAA,SAAA,QAAA,UAAA,EACA,QAAA,QAAA,UAAA,EAEM,qBAAuB,CAE3B,YAAa,uBAAwB,2BAA4B,6BAA8B,SAE/F,YAAa,eAAgB,YAQzB,oBAAsB,OAAO,IAAI,WAAW,EAUlD,oCAA2C,UAAqB,CAC9D,KAAM,iBAAkB,OAAO,eAAe,SAAS,EAAE,YAAY,qBACrE,GAAI,MAAO,kBAAoB,UAC1B,kBAAoB,MACpB,MAAO,iBAAgB,KAAQ,UAC/B,MAAO,iBAAgB,SAAY,SACtC,MAAO,CAAE,IAAK,gBAAgB,IAAK,QAAS,gBAAgB,OAAO,EAC9D,GAAI,gBAET,KAAM,IAAI,OAAM,+CAA+C,UAAU,KAAK,OAAO,CAGzF,CAZA,QAAA,2BAAA,2BAmBA,gCAAuC,MAAY,CACjD,KAAM,WAAY,AAAC,OAA6D,QAAU,OAEpF,kBAAoB,kBAAkB,KAAK,EAC9C,IAAI,WAAa,2BAA2B,SAAS,CAAC,EACtD,OAAO,SAAS,EAChB,OAAO,MAAQ,qBAAqB,KAAK,QAAU,KAAK,IAAI,WAAW,MAAM,CAAC,CAAC,EAGlF,kBAAkB,KAAK,CACrB,IAAK,uBACL,QAAS,oBAAmB,EAC7B,EAGD,KAAM,UAAW,GAAI,KACrB,MAAO,mBAAkB,OAAO,WAAY,CAC1C,KAAM,cAAe,GAAG,UAAU,OAAO,UAAU,UAC7C,YAAc,SAAS,IAAI,YAAY,EAC7C,gBAAS,IAAI,YAAY,EAClB,CAAC,WACV,CAAC,CACH,CAtBA,QAAA,uBAAA,uBA4BA,2BAA2B,UAAqB,CAC9C,KAAM,YAAa,CAAC,SAAS,EAC7B,iBAAU,KAAK,SACZ,OAAO,OAAS,CAAC,QAAA,MAAM,QAAQ,KAAK,GAAK,CAAC,QAAA,MAAM,QAAQ,KAAK,CAAC,EAC9D,QAAQ,OAAS,WAAW,KAAK,GAAG,kBAAkB,KAAK,CAAC,CAAC,EACzD,UACT,CAEA,8BAA4B,CAC1B,GAAI,WAAY,QAAQ,IAAI,WAI5B,MAAK,YACH,WAAY,WAAW,QAAQ,WAOjC,UAAY,UAAU,QAAQ,mBAAoB,GAAG,EAE9C,SACT",
  "names": []
}
