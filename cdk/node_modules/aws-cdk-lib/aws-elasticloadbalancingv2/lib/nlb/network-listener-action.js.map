{
  "version": 3,
  "sources": ["network-listener-action.ts"],
  "sourcesContent": ["import { Duration } from '../../../core';\nimport { CfnListener } from '../elasticloadbalancingv2.generated';\nimport { IListenerAction } from '../shared/listener-action';\nimport { INetworkListener } from './network-listener';\nimport { INetworkTargetGroup } from './network-target-group';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { Construct } from 'constructs';\n\n/**\n * What to do when a client makes a request to a listener\n *\n * Some actions can be combined with other ones (specifically,\n * you can perform authentication before serving the request).\n *\n * Multiple actions form a linked chain; the chain must always terminate in a\n * *(weighted)forward*, *fixedResponse* or *redirect* action.\n *\n * If an action supports chaining, the next action can be indicated\n * by passing it in the `next` property.\n */\nexport class NetworkListenerAction implements IListenerAction {\n  /**\n   * Forward to one or more Target Groups\n   */\n  public static forward(targetGroups: INetworkTargetGroup[], options: NetworkForwardOptions = {}): NetworkListenerAction {\n    if (targetGroups.length === 0) {\n      throw new Error('Need at least one targetGroup in a NetworkListenerAction.forward()');\n    }\n    if (targetGroups.length === 1 && options.stickinessDuration === undefined) {\n      // Render a \"simple\" action for backwards compatibility with old templates\n      return new TargetGroupListenerAction(targetGroups, {\n        type: 'forward',\n        targetGroupArn: targetGroups[0].targetGroupArn,\n      });\n    }\n\n    return new TargetGroupListenerAction(targetGroups, {\n      type: 'forward',\n      forwardConfig: {\n        targetGroups: targetGroups.map(g => ({ targetGroupArn: g.targetGroupArn })),\n        targetGroupStickinessConfig: options.stickinessDuration ? {\n          durationSeconds: options.stickinessDuration.toSeconds(),\n          enabled: true,\n        } : undefined,\n      },\n    });\n  }\n\n  /**\n   * Forward to one or more Target Groups which are weighted differently\n   */\n  public static weightedForward(targetGroups: NetworkWeightedTargetGroup[], options: NetworkForwardOptions = {}): NetworkListenerAction {\n    if (targetGroups.length === 0) {\n      throw new Error('Need at least one targetGroup in a NetworkListenerAction.weightedForward()');\n    }\n\n    return new TargetGroupListenerAction(targetGroups.map(g => g.targetGroup), {\n      type: 'forward',\n      forwardConfig: {\n        targetGroups: targetGroups.map(g => ({ targetGroupArn: g.targetGroup.targetGroupArn, weight: g.weight })),\n        targetGroupStickinessConfig: options.stickinessDuration ? {\n          durationSeconds: options.stickinessDuration.toSeconds(),\n          enabled: true,\n        } : undefined,\n      },\n    });\n  }\n\n  /**\n   * Create an instance of NetworkListenerAction\n   *\n   * The default class should be good enough for most cases and\n   * should be created by using one of the static factory functions,\n   * but allow overriding to make sure we allow flexibility for the future.\n   */\n  protected constructor(private readonly actionJson: CfnListener.ActionProperty, protected readonly next?: NetworkListenerAction) {\n  }\n\n  /**\n   * Render the actions in this chain\n   */\n  public renderActions(): CfnListener.ActionProperty[] {\n    return this.renumber([this.actionJson, ...this.next?.renderActions() ?? []]);\n  }\n\n  /**\n   * Called when the action is being used in a listener\n   */\n  public bind(scope: Construct, listener: INetworkListener) {\n    // Empty on purpose\n    Array.isArray(scope);\n    Array.isArray(listener);\n  }\n\n  /**\n   * Renumber the \"order\" fields in the actions array.\n   *\n   * We don't number for 0 or 1 elements, but otherwise number them 1...#actions\n   * so ELB knows about the right order.\n   *\n   * Do this in `NetworkListenerAction` instead of in `Listener` so that we give\n   * users the opportunity to override by subclassing and overriding `renderActions`.\n   */\n  protected renumber(actions: CfnListener.ActionProperty[]): CfnListener.ActionProperty[] {\n    if (actions.length < 2) { return actions; }\n\n    return actions.map((action, i) => ({ ...action, order: i + 1 }));\n  }\n}\n\n/**\n * Options for `NetworkListenerAction.forward()`\n */\nexport interface NetworkForwardOptions {\n  /**\n   * For how long clients should be directed to the same target group\n   *\n   * Range between 1 second and 7 days.\n   *\n   * @default - No stickiness\n   */\n  readonly stickinessDuration?: Duration;\n}\n\n/**\n * A Target Group and weight combination\n */\nexport interface NetworkWeightedTargetGroup {\n  /**\n   * The target group\n   */\n  readonly targetGroup: INetworkTargetGroup;\n\n  /**\n   * The target group's weight\n   *\n   * Range is [0..1000).\n   *\n   * @default 1\n   */\n  readonly weight?: number;\n}\n\n/**\n * Listener Action that calls \"registerListener\" on TargetGroups\n */\nclass TargetGroupListenerAction extends NetworkListenerAction {\n  constructor(private readonly targetGroups: INetworkTargetGroup[], actionJson: CfnListener.ActionProperty) {\n    super(actionJson);\n  }\n\n  public bind(_scope: Construct, listener: INetworkListener) {\n    for (const tg of this.targetGroups) {\n      tg.registerListener(listener);\n    }\n  }\n}\n"],
  "mappings": "+NAsBA,MAAa,qBAAqB,CAuDhC,YAAuC,WAA2D,KAA4B,CAAvF,KAAA,WAAA,WAA2D,KAAA,KAAA,4MAnDpF,SAAQ,aAAqC,QAAiC,CAAA,EAAE,CAC5F,iGAAI,aAAa,SAAW,EAC1B,KAAM,IAAI,OAAM,oEAAoE,EAEtF,MAAI,cAAa,SAAW,GAAK,QAAQ,qBAAuB,OAEvD,GAAI,2BAA0B,aAAc,CACjD,KAAM,UACN,eAAgB,aAAa,GAAG,eACjC,EAGI,GAAI,2BAA0B,aAAc,CACjD,KAAM,UACN,cAAe,CACb,aAAc,aAAa,IAAI,GAAM,EAAE,eAAgB,EAAE,cAAc,EAAG,EAC1E,4BAA6B,QAAQ,mBAAqB,CACxD,gBAAiB,QAAQ,mBAAmB,UAAS,EACrD,QAAS,IACP,QAEP,QAMW,iBAAgB,aAA4C,QAAiC,CAAA,EAAE,CAC3G,iGAAI,aAAa,SAAW,EAC1B,KAAM,IAAI,OAAM,4EAA4E,EAG9F,MAAO,IAAI,2BAA0B,aAAa,IAAI,GAAK,EAAE,WAAW,EAAG,CACzE,KAAM,UACN,cAAe,CACb,aAAc,aAAa,IAAI,GAAM,EAAE,eAAgB,EAAE,YAAY,eAAgB,OAAQ,EAAE,MAAM,EAAG,EACxG,4BAA6B,QAAQ,mBAAqB,CACxD,gBAAiB,QAAQ,mBAAmB,UAAS,EACrD,QAAS,IACP,QAEP,EAgBI,eAAa,WAClB,MAAO,MAAK,SAAS,CAAC,KAAK,WAAY,GAAA,IAAA,IAAG,KAAK,QAAI,MAAA,KAAA,OAAA,OAAA,GAAE,cAAa,KAAA,MAAA,KAAA,OAAA,GAAM,CAAA,CAAE,CAAC,EAMtE,KAAK,MAAkB,SAA0B,2FAEtD,MAAM,QAAQ,KAAK,EACnB,MAAM,QAAQ,QAAQ,EAYd,SAAS,QAAqC,CACtD,MAAI,SAAQ,OAAS,EAAY,QAE1B,QAAQ,IAAI,CAAC,OAAQ,IAAO,KAAK,OAAQ,MAAO,EAAI,CAAC,EAAG,GAtFnE,QAAA,sBAAA,4JA8HA,MAAM,iCAAkC,sBAAqB,CAC3D,YAA6B,aAAqC,WAAsC,CACtG,MAAM,UAAU,EADW,KAAA,aAAA,aAItB,KAAK,OAAmB,SAA0B,CACvD,SAAW,MAAM,MAAK,aACpB,GAAG,iBAAiB,QAAQ",
  "names": []
}
