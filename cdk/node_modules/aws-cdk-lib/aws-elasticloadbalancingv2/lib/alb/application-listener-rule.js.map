{
  "version": 3,
  "sources": ["application-listener-rule.ts"],
  "sourcesContent": ["import * as cdk from '../../../core';\nimport { Construct } from 'constructs';\nimport { CfnListenerRule } from '../elasticloadbalancingv2.generated';\nimport { IListenerAction } from '../shared/listener-action';\nimport { IApplicationListener } from './application-listener';\nimport { ListenerAction } from './application-listener-action';\nimport { IApplicationTargetGroup } from './application-target-group';\nimport { ListenerCondition } from './conditions';\n\n/**\n * Basic properties for defining a rule on a listener\n */\nexport interface BaseApplicationListenerRuleProps {\n  /**\n   * Priority of the rule\n   *\n   * The rule with the lowest priority will be used for every request.\n   *\n   * Priorities must be unique.\n   */\n  readonly priority: number;\n\n  /**\n   * Target groups to forward requests to.\n   *\n   * Only one of `action`, `fixedResponse`, `redirectResponse` or `targetGroups` can be specified.\n   *\n   * Implies a `forward` action.\n   *\n   * @default - No target groups.\n   */\n  readonly targetGroups?: IApplicationTargetGroup[];\n\n  /**\n   * Action to perform when requests are received\n   *\n   * Only one of `action`, `fixedResponse`, `redirectResponse` or `targetGroups` can be specified.\n   *\n   * @default - No action\n   */\n  readonly action?: ListenerAction;\n\n  /**\n   * Fixed response to return.\n   *\n   * Only one of `action`, `fixedResponse`, `redirectResponse` or `targetGroups` can be specified.\n   *\n   * @default - No fixed response.\n   * @deprecated Use `action` instead.\n   */\n  readonly fixedResponse?: FixedResponse;\n\n  /**\n   * Redirect response to return.\n   *\n   * Only one of `action`, `fixedResponse`, `redirectResponse` or `targetGroups` can be specified.\n   *\n   * @default - No redirect response.\n   * @deprecated Use `action` instead.\n   */\n  readonly redirectResponse?: RedirectResponse;\n\n  /**\n   * Rule applies if matches the conditions.\n   *\n   * @see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html\n   *\n   * @default - No conditions.\n   */\n  readonly conditions?: ListenerCondition[];\n\n  /**\n   * Rule applies if the requested host matches the indicated host\n   *\n   * May contain up to three '*' wildcards.\n   *\n   * @see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#host-conditions\n   *\n   * @default - No host condition.\n   * @deprecated Use `conditions` instead.\n   */\n  readonly hostHeader?: string;\n\n  /**\n   * Rule applies if the requested path matches the given path pattern\n   *\n   * @see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#path-conditions\n   * @default - No path condition.\n   * @deprecated Use `conditions` instead.\n   */\n  readonly pathPattern?: string;\n\n  /**\n   * Rule applies if the requested path matches any of the given patterns.\n   *\n   * Paths may contain up to three '*' wildcards.\n   *\n   * @see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#path-conditions\n   * @default - No path conditions.\n   * @deprecated Use `conditions` instead.\n   */\n  readonly pathPatterns?: string[];\n}\n\n/**\n * Properties for defining a listener rule\n */\nexport interface ApplicationListenerRuleProps extends BaseApplicationListenerRuleProps {\n  /**\n   * The listener to attach the rule to\n   */\n  readonly listener: IApplicationListener;\n}\n\n/**\n * The content type for a fixed response\n * @deprecated superceded by `FixedResponseOptions`.\n */\nexport enum ContentType {\n  TEXT_PLAIN = 'text/plain',\n  TEXT_CSS = 'text/css',\n  TEXT_HTML = 'text/html',\n  APPLICATION_JAVASCRIPT = 'application/javascript',\n  APPLICATION_JSON = 'application/json'\n}\n\n/**\n * A fixed response\n * @deprecated superceded by `ListenerAction.fixedResponse()`.\n */\nexport interface FixedResponse {\n  /**\n   * The HTTP response code (2XX, 4XX or 5XX)\n   */\n  readonly statusCode: string;\n\n  /**\n   * The content type\n   *\n   * @default text/plain\n   */\n  readonly contentType?: ContentType;\n\n  /**\n   * The message\n   *\n   * @default no message\n   */\n  readonly messageBody?: string;\n}\n\n/**\n * A redirect response\n * @deprecated superceded by `ListenerAction.redirect()`.\n */\nexport interface RedirectResponse {\n  /**\n   * The hostname. This component is not percent-encoded. The hostname can contain #{host}.\n   *\n   * @default origin host of request\n   */\n  readonly host?: string;\n  /**\n   * The absolute path, starting with the leading \"/\". This component is not percent-encoded.\n   * The path can contain #{host}, #{path}, and #{port}.\n   *\n   * @default origin path of request\n   */\n  readonly path?: string;\n  /**\n   * The port. You can specify a value from 1 to 65535 or #{port}.\n   *\n   * @default origin port of request\n   */\n  readonly port?: string;\n  /**\n   * The protocol. You can specify HTTP, HTTPS, or #{protocol}. You can redirect HTTP to HTTP,\n   * HTTP to HTTPS, and HTTPS to HTTPS. You cannot redirect HTTPS to HTTP.\n   *\n   * @default origin protocol of request\n   */\n  readonly protocol?: string;\n  /**\n   * The query parameters, URL-encoded when necessary, but not percent-encoded.\n   * Do not include the leading \"?\", as it is automatically added.\n   * You can specify any of the reserved keywords.\n   *\n   * @default origin query string of request\n   */\n  readonly query?: string;\n  /**\n   * The HTTP redirect code (HTTP_301 or HTTP_302)\n   */\n  readonly statusCode: string;\n}\n\n/**\n * Define a new listener rule\n */\nexport class ApplicationListenerRule extends Construct {\n  /**\n   * The ARN of this rule\n   */\n  public readonly listenerRuleArn: string;\n\n  private readonly conditions: ListenerCondition[];\n  private readonly legacyConditions: {[key: string]: string[]} = {};\n\n  private readonly listener: IApplicationListener;\n  private action?: IListenerAction;\n\n  constructor(scope: Construct, id: string, props: ApplicationListenerRuleProps) {\n    super(scope, id);\n\n    this.conditions = props.conditions || [];\n\n    const hasPathPatterns = props.pathPatterns || props.pathPattern;\n    if (this.conditions.length === 0 && !props.hostHeader && !hasPathPatterns) {\n      throw new Error('At least one of \\'conditions\\', \\'hostHeader\\', \\'pathPattern\\' or \\'pathPatterns\\' is required when defining a load balancing rule.');\n    }\n\n    const possibleActions: Array<keyof ApplicationListenerRuleProps> = ['action', 'targetGroups', 'fixedResponse', 'redirectResponse'];\n    const providedActions = possibleActions.filter(action => props[action] !== undefined);\n    if (providedActions.length > 1) {\n      throw new Error(`'${providedActions}' specified together, specify only one`);\n    }\n\n    if (!cdk.Token.isUnresolved(props.priority) && props.priority <= 0) {\n      throw new Error('Priority must have value greater than or equal to 1');\n    }\n\n    this.listener = props.listener;\n\n    const resource = new CfnListenerRule(this, 'Resource', {\n      listenerArn: props.listener.listenerArn,\n      priority: props.priority,\n      conditions: cdk.Lazy.any({ produce: () => this.renderConditions() }),\n      actions: cdk.Lazy.any({ produce: () => this.action ? this.action.renderActions() : [] }),\n    });\n\n    if (props.hostHeader) {\n      this.setCondition('host-header', [props.hostHeader]);\n    }\n\n    if (hasPathPatterns) {\n      if (props.pathPattern && props.pathPatterns) {\n        throw new Error('Both `pathPatterns` and `pathPattern` are specified, specify only one');\n      }\n      const pathPattern = props.pathPattern ? [props.pathPattern] : props.pathPatterns;\n      this.setCondition('path-pattern', pathPattern);\n    }\n\n    if (props.action) {\n      this.configureAction(props.action);\n    }\n\n    (props.targetGroups || []).forEach((group) => {\n      this.configureAction(ListenerAction.forward([group]));\n    });\n\n    if (props.fixedResponse) {\n      this.addFixedResponse(props.fixedResponse);\n    } else if (props.redirectResponse) {\n      this.addRedirectResponse(props.redirectResponse);\n    }\n\n    this.listenerRuleArn = resource.ref;\n\n    this.node.addValidation({ validate: () => this.validateListenerRule() });\n  }\n\n  /**\n   * Add a non-standard condition to this rule\n   *\n   * If the condition conflicts with an already set condition, it will be overwritten by the one you specified.\n   *\n   * @deprecated use `addCondition` instead.\n   */\n  public setCondition(field: string, values: string[] | undefined) {\n    if (values === undefined) {\n      delete this.legacyConditions[field];\n      return;\n    }\n\n    this.legacyConditions[field] = values;\n  }\n\n  /**\n   * Add a non-standard condition to this rule\n   */\n  public addCondition(condition: ListenerCondition) {\n    this.conditions.push(condition);\n  }\n\n  /**\n   * Configure the action to perform for this rule\n   */\n  public configureAction(action: ListenerAction) {\n    // It might make sense to 'throw' here.\n    //\n    // However, programs may already exist out there which configured an action twice,\n    // in which case the second action accidentally overwrite the initial action, and in some\n    // way ended up with a program that did what the author intended. If we were to add throw now,\n    // the previously working program would be broken.\n    //\n    // Instead, signal this through a warning.\n    // @deprecate: upon the next major version bump, replace this with a `throw`\n    if (this.action) {\n      cdk.Annotations.of(this).addWarning('An Action already existed on this ListenerRule and was replaced. Configure exactly one default Action.');\n    }\n\n    action.bind(this, this.listener, this);\n    this.action = action;\n  }\n\n  /**\n   * Add a TargetGroup to load balance to\n   *\n   * @deprecated Use configureAction instead\n   */\n  public addTargetGroup(targetGroup: IApplicationTargetGroup) {\n    this.configureAction(ListenerAction.forward([targetGroup]));\n  }\n\n  /**\n   * Add a fixed response\n   *\n   * @deprecated Use configureAction instead\n   */\n  public addFixedResponse(fixedResponse: FixedResponse) {\n    validateFixedResponse(fixedResponse);\n\n    this.configureAction(ListenerAction.fixedResponse(cdk.Token.asNumber(fixedResponse.statusCode), {\n      contentType: fixedResponse.contentType,\n      messageBody: fixedResponse.messageBody,\n    }));\n  }\n\n  /**\n   * Add a redirect response\n   *\n   * @deprecated Use configureAction instead\n   */\n  public addRedirectResponse(redirectResponse: RedirectResponse) {\n    validateRedirectResponse(redirectResponse);\n\n    this.configureAction(ListenerAction.redirect({\n      host: redirectResponse.host,\n      path: redirectResponse.path,\n      permanent: redirectResponse.statusCode === 'HTTP_301',\n      port: redirectResponse.port,\n      protocol: redirectResponse.protocol,\n      query: redirectResponse.query,\n    }));\n  }\n\n  /**\n   * Validate the rule\n   */\n  private validateListenerRule() {\n    if (this.action === undefined) {\n      return ['Listener rule needs at least one action'];\n    }\n\n    const legacyConditionFields = Object.keys(this.legacyConditions);\n    if (legacyConditionFields.length === 0 && this.conditions.length === 0) {\n      return ['Listener rule needs at least one condition'];\n    }\n\n    return [];\n  }\n\n  /**\n   * Render the conditions for this rule\n   */\n  private renderConditions(): any {\n    const legacyConditions = Object.entries(this.legacyConditions).map(([field, values]) => {\n      return { field, values };\n    });\n    const conditions = this.conditions.map(condition => condition.renderRawCondition());\n\n    return [\n      ...legacyConditions,\n      ...conditions,\n    ];\n  }\n}\n\n/**\n * Validate the status code and message body of a fixed response\n * @internal\n * @deprecated\n */\nfunction validateFixedResponse(fixedResponse: FixedResponse) {\n  if (fixedResponse.statusCode && !/^(2|4|5)\\d\\d$/.test(fixedResponse.statusCode)) {\n    throw new Error('`statusCode` must be 2XX, 4XX or 5XX.');\n  }\n\n  if (fixedResponse.messageBody && fixedResponse.messageBody.length > 1024) {\n    throw new Error('`messageBody` cannot have more than 1024 characters.');\n  }\n}\n\n/**\n * Validate the status code and message body of a redirect response\n * @internal\n * @deprecated\n */\nfunction validateRedirectResponse(redirectResponse: RedirectResponse) {\n  if (redirectResponse.protocol && !/^(HTTPS?|#\\{protocol\\})$/i.test(redirectResponse.protocol)) {\n    throw new Error('`protocol` must be HTTP, HTTPS, or #{protocol}.');\n  }\n\n  if (!redirectResponse.statusCode || !/^HTTP_30[12]$/.test(redirectResponse.statusCode)) {\n    throw new Error('`statusCode` must be HTTP_301 or HTTP_302.');\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
