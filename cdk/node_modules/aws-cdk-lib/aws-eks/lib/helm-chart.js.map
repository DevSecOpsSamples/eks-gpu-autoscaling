{
  "version": 3,
  "sources": ["helm-chart.ts"],
  "sourcesContent": ["import { Asset } from '../../aws-s3-assets';\nimport { CustomResource, Duration, Names, Stack } from '../../core';\nimport { Construct } from 'constructs';\nimport { ICluster } from './cluster';\nimport { KubectlProvider } from './kubectl-provider';\n\n/**\n * Helm Chart options.\n */\n\nexport interface HelmChartOptions {\n  /**\n   * The name of the chart.\n   * Either this or `chartAsset` must be specified.\n   *\n   * @default - No chart name. Implies `chartAsset` is used.\n   */\n  readonly chart?: string;\n\n  /**\n   * The name of the release.\n   * @default - If no release name is given, it will use the last 53 characters of the node's unique id.\n   */\n  readonly release?: string;\n\n  /**\n   * The chart version to install.\n   * @default - If this is not specified, the latest version is installed\n   */\n  readonly version?: string;\n\n  /**\n   * The repository which contains the chart. For example: https://kubernetes-charts.storage.googleapis.com/\n   * @default - No repository will be used, which means that the chart needs to be an absolute URL.\n   */\n  readonly repository?: string;\n\n  /**\n  * The chart in the form of an asset.\n  * Either this or `chart` must be specified.\n  *\n  * @default - No chart asset. Implies `chart` is used.\n  */\n  readonly chartAsset?: Asset;\n\n  /**\n   * The Kubernetes namespace scope of the requests.\n   * @default default\n   */\n  readonly namespace?: string;\n\n  /**\n   * The values to be used by the chart.\n   * @default - No values are provided to the chart.\n   */\n  readonly values?: {[key: string]: any};\n\n  /**\n   * Whether or not Helm should wait until all Pods, PVCs, Services, and minimum number of Pods of a\n   * Deployment, StatefulSet, or ReplicaSet are in a ready state before marking the release as successful.\n   * @default - Helm will not wait before marking release as successful\n   */\n  readonly wait?: boolean;\n\n  /**\n   * Amount of time to wait for any individual Kubernetes operation. Maximum 15 minutes.\n   * @default Duration.minutes(5)\n   */\n  readonly timeout?: Duration;\n\n  /**\n   * create namespace if not exist\n   * @default true\n   */\n  readonly createNamespace?: boolean;\n}\n\n/**\n * Helm Chart properties.\n */\nexport interface HelmChartProps extends HelmChartOptions {\n  /**\n   * The EKS cluster to apply this configuration to.\n   *\n   * [disable-awslint:ref-via-interface]\n   */\n  readonly cluster: ICluster;\n}\n\n/**\n * Represents a helm chart within the Kubernetes system.\n *\n * Applies/deletes the resources using `kubectl` in sync with the resource.\n */\nexport class HelmChart extends Construct {\n  /**\n   * The CloudFormation resource type.\n   */\n  public static readonly RESOURCE_TYPE = 'Custom::AWSCDK-EKS-HelmChart';\n\n  constructor(scope: Construct, id: string, props: HelmChartProps) {\n    super(scope, id);\n\n    const stack = Stack.of(this);\n\n    const provider = KubectlProvider.getOrCreate(this, props.cluster);\n\n    const timeout = props.timeout?.toSeconds();\n    if (timeout && timeout > 900) {\n      throw new Error('Helm chart timeout cannot be higher than 15 minutes.');\n    }\n\n    if (!props.chart && !props.chartAsset) {\n      throw new Error(\"Either 'chart' or 'chartAsset' must be specified to install a helm chart\");\n    }\n\n    if (props.chartAsset && (props.repository || props.version)) {\n      throw new Error(\n        \"Neither 'repository' nor 'version' can be used when configuring 'chartAsset'\",\n      );\n    }\n\n    // default not to wait\n    const wait = props.wait ?? false;\n    // default to create new namespace\n    const createNamespace = props.createNamespace ?? true;\n\n    props.chartAsset?.grantRead(provider.handlerRole);\n\n    new CustomResource(this, 'Resource', {\n      serviceToken: provider.serviceToken,\n      resourceType: HelmChart.RESOURCE_TYPE,\n      properties: {\n        ClusterName: props.cluster.clusterName,\n        RoleArn: provider.roleArn, // TODO: bake into the provider's environment\n        Release: props.release ?? Names.uniqueId(this).slice(-53).toLowerCase(), // Helm has a 53 character limit for the name\n        Chart: props.chart,\n        ChartAssetURL: props.chartAsset?.s3ObjectUrl,\n        Version: props.version,\n        Wait: wait || undefined, // props are stringified so we encode \u201Cfalse\u201D as undefined\n        Timeout: timeout ? `${timeout.toString()}s` : undefined, // Helm v3 expects duration instead of integer\n        Values: (props.values ? stack.toJsonString(props.values) : undefined),\n        Namespace: props.namespace ?? 'default',\n        Repository: props.repository,\n        CreateNamespace: createNamespace || undefined,\n      },\n    });\n  }\n}\n"],
  "mappings": "gNACA,OAAA,QAAA,YAAA,EACA,aAAA,QAAA,YAAA,EAEA,mBAAA,QAAA,oBAAA,EA0FA,MAAa,iBAAkB,cAAA,SAAS,CAMtC,YAAY,MAAkB,GAAY,MAAqB,0BAC7D,MAAM,MAAO,EAAE,oEAEf,KAAM,OAAQ,OAAA,MAAM,GAAG,IAAI,EAErB,SAAW,mBAAA,gBAAgB,YAAY,KAAM,MAAM,OAAO,EAE1D,QAAO,IAAG,MAAM,WAAO,MAAA,KAAA,OAAA,OAAA,GAAE,UAAS,EACxC,GAAI,SAAW,QAAU,IACvB,KAAM,IAAI,OAAM,sDAAsD,EAGxE,GAAI,CAAC,MAAM,OAAS,CAAC,MAAM,WACzB,KAAM,IAAI,OAAM,0EAA0E,EAG5F,GAAI,MAAM,YAAe,OAAM,YAAc,MAAM,SACjD,KAAM,IAAI,OACR,8EAA8E,EAKlF,KAAM,MAAI,IAAG,MAAM,QAAI,MAAA,KAAA,OAAA,GAAI,GAErB,gBAAe,IAAG,MAAM,mBAAe,MAAA,KAAA,OAAA,GAAI,GAEjD,AAAA,IAAA,MAAM,cAAU,MAAA,KAAA,QAAA,GAAE,UAAU,SAAS,WAAW,EAEhD,GAAI,QAAA,eAAe,KAAM,WAAY,CACnC,aAAc,SAAS,aACvB,aAAc,UAAU,cACxB,WAAY,CACV,YAAa,MAAM,QAAQ,YAC3B,QAAS,SAAS,QAClB,QAAO,IAAE,MAAM,WAAO,MAAA,KAAA,OAAA,GAAI,OAAA,MAAM,SAAS,IAAI,EAAE,MAAM,GAAG,EAAE,YAAW,EACrE,MAAO,MAAM,MACb,cAAa,IAAE,MAAM,cAAU,MAAA,KAAA,OAAA,OAAA,GAAE,YACjC,QAAS,MAAM,QACf,KAAM,MAAQ,OACd,QAAS,QAAU,GAAG,QAAQ,SAAQ,KAAQ,OAC9C,OAAS,MAAM,OAAS,MAAM,aAAa,MAAM,MAAM,EAAI,OAC3D,UAAS,IAAE,MAAM,aAAS,MAAA,KAAA,OAAA,GAAI,UAC9B,WAAY,MAAM,WAClB,gBAAiB,iBAAmB,QAEvC,GApDL,QAAA,UAAA,qGAIyB,UAAA,cAAgB",
  "names": []
}
