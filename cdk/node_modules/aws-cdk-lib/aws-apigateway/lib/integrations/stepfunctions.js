"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.StepFunctionsIntegration=void 0;const jsiiDeprecationWarnings=require("../../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),fs=require("fs"),path=require("path"),iam=require("../../../aws-iam"),sfn=require("../../../aws-stepfunctions"),core_1=require("../../../core"),integration_1=require("../integration"),model_1=require("../model"),aws_1=require("./aws");class StepFunctionsIntegration{static startExecution(stateMachine,options){return jsiiDeprecationWarnings.aws_cdk_lib_aws_stepfunctions_IStateMachine(stateMachine),jsiiDeprecationWarnings.aws_cdk_lib_aws_apigateway_StepFunctionsExecutionIntegrationOptions(options),new StepFunctionsExecutionIntegration(stateMachine,options)}}exports.StepFunctionsIntegration=StepFunctionsIntegration,_a=JSII_RTTI_SYMBOL_1,StepFunctionsIntegration[_a]={fqn:"aws-cdk-lib.aws_apigateway.StepFunctionsIntegration",version:"2.20.0"};class StepFunctionsExecutionIntegration extends aws_1.AwsIntegration{constructor(stateMachine,options={}){super({service:"states",action:"StartSyncExecution",options:{credentialsRole:options.credentialsRole,integrationResponses:integrationResponse(),passthroughBehavior:integration_1.PassthroughBehavior.NEVER,requestTemplates:requestTemplates(stateMachine,options),...options}});this.stateMachine=stateMachine}bind(method){var _b,_c;const bindResult=super.bind(method),credentialsRole=(_c=(_b=bindResult.options)===null||_b===void 0?void 0:_b.credentialsRole)!==null&&_c!==void 0?_c:new iam.Role(method,"StartSyncExecutionRole",{assumedBy:new iam.ServicePrincipal("apigateway.amazonaws.com")});this.stateMachine.grantStartSyncExecution(credentialsRole);let stateMachineName;if(this.stateMachine instanceof sfn.StateMachine){if(this.stateMachine.stateMachineType!==sfn.StateMachineType.EXPRESS)throw new Error('State Machine must be of type "EXPRESS". Please use StateMachineType.EXPRESS as the stateMachineType');stateMachineName=this.stateMachine.node.defaultChild.stateMachineName}else stateMachineName=`StateMachine-${this.stateMachine.stack.node.addr}`;let deploymentToken;stateMachineName!==void 0&&!core_1.Token.isUnresolved(stateMachineName)&&(deploymentToken=JSON.stringify({stateMachineName}));for(const methodResponse of METHOD_RESPONSES)method.addMethodResponse(methodResponse);return{...bindResult,options:{...bindResult.options,credentialsRole},deploymentToken}}}function integrationResponse(){const errorResponse=[{selectionPattern:"4\\d{2}",statusCode:"400",responseTemplates:{"application/json":`{
            "error": "Bad request!"
          }`}},{selectionPattern:"5\\d{2}",statusCode:"500",responseTemplates:{"application/json":`"error": $input.path('$.error')`}}];return[{statusCode:"200",responseTemplates:{"application/json":["#set($inputRoot = $input.path('$'))",`#if($input.path('$.status').toString().equals("FAILED"))`,"#set($context.responseOverride.status = 500)","{",`"error": "$input.path('$.error')",`,`"cause": "$input.path('$.cause')"`,"}","#else","$input.path('$.output')","#end"].join(`
`)}},...errorResponse]}function requestTemplates(stateMachine,options){return{"application/json":templateString(stateMachine,options)}}function templateString(stateMachine,options){var _b,_c,_d,_e;let templateStr,requestContextStr="";const includeHeader=(_b=options.headers)!==null&&_b!==void 0?_b:!1,includeQueryString=(_c=options.querystring)!==null&&_c!==void 0?_c:!0,includePath=(_d=options.path)!==null&&_d!==void 0?_d:!0,includeAuthorizer=(_e=options.authorizer)!==null&&_e!==void 0?_e:!1;return options.requestContext&&Object.keys(options.requestContext).length>0&&(requestContextStr=requestContext(options.requestContext)),templateStr=fs.readFileSync(path.join(__dirname,"stepfunctions.vtl"),{encoding:"utf-8"}),templateStr=templateStr.replace("%STATEMACHINE%",stateMachine.stateMachineArn),templateStr=templateStr.replace("%INCLUDE_HEADERS%",String(includeHeader)),templateStr=templateStr.replace("%INCLUDE_QUERYSTRING%",String(includeQueryString)),templateStr=templateStr.replace("%INCLUDE_PATH%",String(includePath)),templateStr=templateStr.replace("%INCLUDE_AUTHORIZER%",String(includeAuthorizer)),templateStr=templateStr.replace("%REQUESTCONTEXT%",requestContextStr),templateStr}function requestContext(requestContextObj){const context={accountId:requestContextObj!=null&&requestContextObj.accountId?"$context.identity.accountId":void 0,apiId:requestContextObj!=null&&requestContextObj.apiId?"$context.apiId":void 0,apiKey:requestContextObj!=null&&requestContextObj.apiKey?"$context.identity.apiKey":void 0,authorizerPrincipalId:requestContextObj!=null&&requestContextObj.authorizerPrincipalId?"$context.authorizer.principalId":void 0,caller:requestContextObj!=null&&requestContextObj.caller?"$context.identity.caller":void 0,cognitoAuthenticationProvider:requestContextObj!=null&&requestContextObj.cognitoAuthenticationProvider?"$context.identity.cognitoAuthenticationProvider":void 0,cognitoAuthenticationType:requestContextObj!=null&&requestContextObj.cognitoAuthenticationType?"$context.identity.cognitoAuthenticationType":void 0,cognitoIdentityId:requestContextObj!=null&&requestContextObj.cognitoIdentityId?"$context.identity.cognitoIdentityId":void 0,cognitoIdentityPoolId:requestContextObj!=null&&requestContextObj.cognitoIdentityPoolId?"$context.identity.cognitoIdentityPoolId":void 0,httpMethod:requestContextObj!=null&&requestContextObj.httpMethod?"$context.httpMethod":void 0,stage:requestContextObj!=null&&requestContextObj.stage?"$context.stage":void 0,sourceIp:requestContextObj!=null&&requestContextObj.sourceIp?"$context.identity.sourceIp":void 0,user:requestContextObj!=null&&requestContextObj.user?"$context.identity.user":void 0,userAgent:requestContextObj!=null&&requestContextObj.userAgent?"$context.identity.userAgent":void 0,userArn:requestContextObj!=null&&requestContextObj.userArn?"$context.identity.userArn":void 0,requestId:requestContextObj!=null&&requestContextObj.requestId?"$context.requestId":void 0,resourceId:requestContextObj!=null&&requestContextObj.resourceId?"$context.resourceId":void 0,resourcePath:requestContextObj!=null&&requestContextObj.resourcePath?"$context.resourcePath":void 0},contextAsString=JSON.stringify(context),doublequotes='"',replaceWith="@@";return contextAsString.split(doublequotes).join(replaceWith)}const METHOD_RESPONSES=[{statusCode:"200",responseModels:{"application/json":model_1.Model.EMPTY_MODEL}},{statusCode:"400",responseModels:{"application/json":model_1.Model.ERROR_MODEL}},{statusCode:"500",responseModels:{"application/json":model_1.Model.ERROR_MODEL}}];
//# sourceMappingURL=stepfunctions.js.map
