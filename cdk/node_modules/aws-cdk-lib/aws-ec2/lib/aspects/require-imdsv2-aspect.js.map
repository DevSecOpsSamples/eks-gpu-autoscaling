{
  "version": 3,
  "sources": ["require-imdsv2-aspect.ts"],
  "sourcesContent": ["import * as cdk from '../../../core';\nimport * as cxapi from '../../../cx-api';\nimport { IConstruct } from 'constructs';\nimport { CfnLaunchTemplate } from '../ec2.generated';\nimport { Instance } from '../instance';\nimport { LaunchTemplate } from '../launch-template';\n\n/**\n * Properties for `RequireImdsv2Aspect`.\n */\ninterface RequireImdsv2AspectProps {\n  /**\n   * Whether warning annotations from this Aspect should be suppressed or not.\n   *\n   * @default - false\n   */\n  readonly suppressWarnings?: boolean;\n}\n\n/**\n * Base class for Aspect that makes IMDSv2 required.\n */\nabstract class RequireImdsv2Aspect implements cdk.IAspect {\n  protected readonly suppressWarnings: boolean;\n\n  constructor(props?: RequireImdsv2AspectProps) {\n    this.suppressWarnings = props?.suppressWarnings ?? false;\n  }\n\n  abstract visit(node: IConstruct): void;\n\n  /**\n   * Adds a warning annotation to a node, unless `suppressWarnings` is true.\n   *\n   * @param node The scope to add the warning to.\n   * @param message The warning message.\n   */\n  protected warn(node: IConstruct, message: string) {\n    if (this.suppressWarnings !== true) {\n      cdk.Annotations.of(node).addWarning(`${RequireImdsv2Aspect.name} failed on node ${node.node.id}: ${message}`);\n    }\n  }\n}\n\n/**\n * Properties for `InstanceRequireImdsv2Aspect`.\n */\nexport interface InstanceRequireImdsv2AspectProps extends RequireImdsv2AspectProps {\n  /**\n   * Whether warnings that would be raised when an Instance is associated with an existing Launch Template\n   * should be suppressed or not.\n   *\n   * You can set this to `true` if `LaunchTemplateImdsAspect` is being used alongside this Aspect to\n   * suppress false-positive warnings because any Launch Templates associated with Instances will still be covered.\n   *\n   * @default - false\n   */\n  readonly suppressLaunchTemplateWarning?: boolean;\n}\n\n/**\n * Aspect that applies IMDS configuration on EC2 Instance constructs.\n *\n * This aspect configures IMDS on an EC2 instance by creating a Launch Template with the\n * IMDS configuration and associating that Launch Template with the instance. If an Instance\n * is already associated with a Launch Template, a warning will (optionally) be added to the\n * construct node and it will be skipped.\n *\n * To cover Instances already associated with Launch Templates, use `LaunchTemplateImdsAspect`.\n */\nexport class InstanceRequireImdsv2Aspect extends RequireImdsv2Aspect {\n  private readonly suppressLaunchTemplateWarning: boolean;\n\n  constructor(props?: InstanceRequireImdsv2AspectProps) {\n    super(props);\n    this.suppressLaunchTemplateWarning = props?.suppressLaunchTemplateWarning ?? false;\n  }\n\n  visit(node: IConstruct): void {\n    if (!(node instanceof Instance)) {\n      return;\n    }\n    if (node.instance.launchTemplate !== undefined) {\n      this.warn(node, 'Cannot toggle IMDSv1 because this Instance is associated with an existing Launch Template.');\n      return;\n    }\n\n    const launchTemplate = new CfnLaunchTemplate(node, 'LaunchTemplate', {\n      launchTemplateData: {\n        metadataOptions: {\n          httpTokens: 'required',\n        },\n      },\n    });\n    if (cdk.FeatureFlags.of(node).isEnabled(cxapi.EC2_UNIQUE_IMDSV2_LAUNCH_TEMPLATE_NAME)) {\n      launchTemplate.launchTemplateName = cdk.Names.uniqueId(launchTemplate);\n    } else {\n      launchTemplate.launchTemplateName = `${node.node.id}LaunchTemplate`;\n    }\n    node.instance.launchTemplate = {\n      launchTemplateName: launchTemplate.launchTemplateName,\n      version: launchTemplate.getAtt('LatestVersionNumber').toString(),\n    };\n  }\n\n  protected warn(node: IConstruct, message: string) {\n    if (this.suppressLaunchTemplateWarning !== true) {\n      super.warn(node, message);\n    }\n  }\n}\n\n/**\n * Properties for `LaunchTemplateRequireImdsv2Aspect`.\n */\nexport interface LaunchTemplateRequireImdsv2AspectProps extends RequireImdsv2AspectProps {}\n\n/**\n * Aspect that applies IMDS configuration on EC2 Launch Template constructs.\n *\n * @see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-launchtemplate-launchtemplatedata-metadataoptions.html\n */\nexport class LaunchTemplateRequireImdsv2Aspect extends RequireImdsv2Aspect {\n  constructor(props?: LaunchTemplateRequireImdsv2AspectProps) {\n    super(props);\n  }\n\n  visit(node: IConstruct): void {\n    if (!(node instanceof LaunchTemplate)) {\n      return;\n    }\n\n    const launchTemplate = node.node.tryFindChild('Resource') as CfnLaunchTemplate;\n    const data = launchTemplate.launchTemplateData;\n    if (cdk.isResolvableObject(data)) {\n      this.warn(node, 'LaunchTemplateData is a CDK token.');\n      return;\n    }\n\n    const metadataOptions = (data as CfnLaunchTemplate.LaunchTemplateDataProperty).metadataOptions;\n    if (cdk.isResolvableObject(metadataOptions)) {\n      this.warn(node, 'LaunchTemplateData.MetadataOptions is a CDK token.');\n      return;\n    }\n\n    const newData: CfnLaunchTemplate.LaunchTemplateDataProperty = {\n      ...data,\n      metadataOptions: {\n        ...metadataOptions,\n        httpTokens: 'required',\n      },\n    };\n    launchTemplate.launchTemplateData = newData;\n  }\n}\n"],
  "mappings": "kRAAA,IAAA,QAAA,eAAA,EACA,MAAA,QAAA,iBAAA,EAEA,gBAAA,QAAA,kBAAA,EACA,WAAA,QAAA,aAAA,EACA,kBAAA,QAAA,oBAAA,EAiBA,MAAe,mBAAmB,CAGhC,YAAY,MAAgC,QAC1C,KAAK,iBAAgB,IAAG,OAAK,KAAA,OAAL,MAAO,oBAAgB,MAAA,KAAA,OAAA,GAAI,GAW3C,KAAK,KAAkB,QAAe,CAC9C,AAAI,KAAK,mBAAqB,IAC5B,IAAI,YAAY,GAAG,IAAI,EAAE,WAAW,GAAG,oBAAoB,uBAAuB,KAAK,KAAK,OAAO,SAAS,GA+BlH,MAAa,mCAAoC,oBAAmB,CAGlE,YAAY,MAAwC,QAClD,MAAM,KAAK,sFACX,KAAK,8BAA6B,IAAG,OAAK,KAAA,OAAL,MAAO,iCAA6B,MAAA,KAAA,OAAA,GAAI,GAG/E,MAAM,KAAgB,CACpB,GAAI,CAAE,gBAAgB,YAAA,UACpB,OAEF,GAAI,KAAK,SAAS,iBAAmB,OAAW,CAC9C,KAAK,KAAK,KAAM,4FAA4F,EAC5G,OAGF,KAAM,gBAAiB,GAAI,iBAAA,kBAAkB,KAAM,iBAAkB,CACnE,mBAAoB,CAClB,gBAAiB,CACf,WAAY,aAGjB,EACD,AAAI,IAAI,aAAa,GAAG,IAAI,EAAE,UAAU,MAAM,sCAAsC,EAClF,eAAe,mBAAqB,IAAI,MAAM,SAAS,cAAc,EAErE,eAAe,mBAAqB,GAAG,KAAK,KAAK,mBAEnD,KAAK,SAAS,eAAiB,CAC7B,mBAAoB,eAAe,mBACnC,QAAS,eAAe,OAAO,qBAAqB,EAAE,SAAQ,GAIxD,KAAK,KAAkB,QAAe,CAC9C,AAAI,KAAK,gCAAkC,IACzC,MAAM,KAAK,KAAM,OAAO,GArC9B,QAAA,4BAAA,2JAoDA,MAAa,yCAA0C,oBAAmB,CACxE,YAAY,MAA8C,CACxD,MAAM,KAAK,4FAGb,MAAM,KAAgB,CACpB,GAAI,CAAE,gBAAgB,mBAAA,gBACpB,OAGF,KAAM,gBAAiB,KAAK,KAAK,aAAa,UAAU,EAClD,KAAO,eAAe,mBAC5B,GAAI,IAAI,mBAAmB,IAAI,EAAG,CAChC,KAAK,KAAK,KAAM,oCAAoC,EACpD,OAGF,KAAM,iBAAmB,KAAsD,gBAC/E,GAAI,IAAI,mBAAmB,eAAe,EAAG,CAC3C,KAAK,KAAK,KAAM,oDAAoD,EACpE,OAGF,KAAM,SAAwD,IACzD,KACH,gBAAiB,IACZ,gBACH,WAAY,aAGhB,eAAe,mBAAqB,SA9BxC,QAAA,kCAAA",
  "names": []
}
