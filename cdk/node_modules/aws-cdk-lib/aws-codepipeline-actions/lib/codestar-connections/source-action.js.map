{
  "version": 3,
  "sources": ["source-action.ts"],
  "sourcesContent": ["import * as codepipeline from '../../../aws-codepipeline';\nimport * as iam from '../../../aws-iam';\n\nimport { Action } from '../action';\nimport { sourceArtifactBounds } from '../common';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { Construct } from 'constructs';\n\n/**\n * The CodePipeline variables emitted by CodeStar source Action.\n */\nexport interface CodeStarSourceVariables {\n  /** The name of the repository this action points to. */\n  readonly fullRepositoryName: string;\n  /** The name of the branch this action tracks. */\n  readonly branchName: string;\n  /** The date the currently last commit on the tracked branch was authored, in ISO-8601 format. */\n  readonly authorDate: string;\n  /** The SHA1 hash of the currently last commit on the tracked branch. */\n  readonly commitId: string;\n  /** The message of the currently last commit on the tracked branch. */\n  readonly commitMessage: string;\n  /** The connection ARN this source uses. */\n  readonly connectionArn: string;\n}\n\n/**\n * Construction properties for {@link CodeStarConnectionsSourceAction}.\n */\nexport interface CodeStarConnectionsSourceActionProps extends codepipeline.CommonAwsActionProps {\n  /**\n   * The output artifact that this action produces.\n   * Can be used as input for further pipeline actions.\n   */\n  readonly output: codepipeline.Artifact;\n\n  /**\n   * The ARN of the CodeStar Connection created in the AWS console\n   * that has permissions to access this GitHub or BitBucket repository.\n   *\n   * @example 'arn:aws:codestar-connections:us-east-1:123456789012:connection/12345678-abcd-12ab-34cdef5678gh'\n   * @see https://docs.aws.amazon.com/codepipeline/latest/userguide/connections-create.html\n   */\n  readonly connectionArn: string;\n\n  /**\n   * The owning user or organization of the repository.\n   *\n   * @example 'aws'\n   */\n  readonly owner: string;\n\n  /**\n   * The name of the repository.\n   *\n   * @example 'aws-cdk'\n   */\n  readonly repo: string;\n\n  /**\n   * The branch to build.\n   *\n   * @default 'master'\n   */\n  readonly branch?: string;\n\n  // long URL in @see\n  /**\n   * Whether the output should be the contents of the repository\n   * (which is the default),\n   * or a link that allows CodeBuild to clone the repository before building.\n   *\n   * **Note**: if this option is true,\n   * then only CodeBuild actions can use the resulting {@link output}.\n   *\n   * @default false\n   * @see https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html#action-reference-CodestarConnectionSource-config\n   */\n  readonly codeBuildCloneOutput?: boolean;\n\n  /**\n   * Controls automatically starting your pipeline when a new commit\n   * is made on the configured repository and branch. If unspecified,\n   * the default value is true, and the field does not display by default.\n   *\n   * @default true\n   * @see https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html\n   */\n  readonly triggerOnPush?: boolean;\n}\n\n/**\n * A CodePipeline source action for the CodeStar Connections source,\n * which allows connecting to GitHub and BitBucket.\n */\nexport class CodeStarConnectionsSourceAction extends Action {\n  /**\n   * The name of the property that holds the ARN of the CodeStar Connection\n   * inside of the CodePipeline Artifact's metadata.\n   *\n   * @internal\n   */\n  public static readonly _CONNECTION_ARN_PROPERTY = 'CodeStarConnectionArnProperty';\n\n  private readonly props: CodeStarConnectionsSourceActionProps;\n\n  constructor(props: CodeStarConnectionsSourceActionProps) {\n    super({\n      ...props,\n      category: codepipeline.ActionCategory.SOURCE,\n      owner: 'AWS', // because props also has a (different!) owner property!\n      provider: 'CodeStarSourceConnection',\n      artifactBounds: sourceArtifactBounds(),\n      outputs: [props.output],\n    });\n\n    this.props = props;\n  }\n\n  /** The variables emitted by this action. */\n  public get variables(): CodeStarSourceVariables {\n    return {\n      fullRepositoryName: this.variableExpression('FullRepositoryName'),\n      branchName: this.variableExpression('BranchName'),\n      authorDate: this.variableExpression('AuthorDate'),\n      commitId: this.variableExpression('CommitId'),\n      commitMessage: this.variableExpression('CommitMessage'),\n      connectionArn: this.variableExpression('ConnectionArn'),\n    };\n  }\n\n  protected bound(_scope: Construct, _stage: codepipeline.IStage, options: codepipeline.ActionBindOptions): codepipeline.ActionConfig {\n    // https://docs.aws.amazon.com/codepipeline/latest/userguide/security-iam.html#how-to-update-role-new-services\n    options.role.addToPolicy(new iam.PolicyStatement({\n      actions: [\n        'codestar-connections:UseConnection',\n      ],\n      resources: [\n        this.props.connectionArn,\n      ],\n    }));\n\n    // the action needs to write the output to the pipeline bucket\n    options.bucket.grantReadWrite(options.role);\n    options.bucket.grantPutAcl(options.role);\n\n    // if codeBuildCloneOutput is true,\n    // save the connectionArn in the Artifact instance\n    // to be read by the CodeBuildAction later\n    if (this.props.codeBuildCloneOutput === true) {\n      this.props.output.setMetadata(CodeStarConnectionsSourceAction._CONNECTION_ARN_PROPERTY,\n        this.props.connectionArn);\n    }\n\n    return {\n      configuration: {\n        ConnectionArn: this.props.connectionArn,\n        FullRepositoryId: `${this.props.owner}/${this.props.repo}`,\n        BranchName: this.props.branch ?? 'master',\n        OutputArtifactFormat: this.props.codeBuildCloneOutput === true\n          ? 'CODEBUILD_CLONE_REF'\n          : undefined,\n        DetectChanges: this.props.triggerOnPush,\n      },\n    };\n  }\n}\n"],
  "mappings": "yOAAA,aAAA,QAAA,2BAAA,EACA,IAAA,QAAA,kBAAA,EAEA,SAAA,QAAA,WAAA,EACA,SAAA,QAAA,WAAA,EA6FA,MAAa,uCAAwC,UAAA,MAAM,CAWzD,YAAY,MAA2C,CACrD,MAAM,IACD,MACH,SAAU,aAAa,eAAe,OACtC,MAAO,MACP,SAAU,2BACV,eAAgB,SAAA,qBAAoB,EACpC,QAAS,CAAC,MAAM,MAAM,EACvB,2GAED,KAAK,MAAQ,SAIJ,YAAS,CAClB,MAAO,CACL,mBAAoB,KAAK,mBAAmB,oBAAoB,EAChE,WAAY,KAAK,mBAAmB,YAAY,EAChD,WAAY,KAAK,mBAAmB,YAAY,EAChD,SAAU,KAAK,mBAAmB,UAAU,EAC5C,cAAe,KAAK,mBAAmB,eAAe,EACtD,cAAe,KAAK,mBAAmB,eAAe,GAIhD,MAAM,OAAmB,OAA6B,QAAuC,mKAErG,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,QAAS,CACP,sCAEF,UAAW,CACT,KAAK,MAAM,eAEd,CAAC,EAGF,QAAQ,OAAO,eAAe,QAAQ,IAAI,EAC1C,QAAQ,OAAO,YAAY,QAAQ,IAAI,EAKnC,KAAK,MAAM,uBAAyB,IACtC,KAAK,MAAM,OAAO,YAAY,gCAAgC,yBAC5D,KAAK,MAAM,aAAa,EAGrB,CACL,cAAe,CACb,cAAe,KAAK,MAAM,cAC1B,iBAAkB,GAAG,KAAK,MAAM,SAAS,KAAK,MAAM,OACpD,WAAU,IAAE,KAAK,MAAM,UAAM,MAAA,KAAA,OAAA,GAAI,SACjC,qBAAsB,KAAK,MAAM,uBAAyB,GACtD,sBACA,OACJ,cAAe,KAAK,MAAM,iBAnElC,QAAA,gCAAA,wLAOyB,gCAAA,yBAA2B",
  "names": []
}
