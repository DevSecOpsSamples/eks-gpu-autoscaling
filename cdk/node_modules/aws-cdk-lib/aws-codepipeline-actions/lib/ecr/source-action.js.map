{
  "version": 3,
  "sources": ["source-action.ts"],
  "sourcesContent": ["import * as codepipeline from '../../../aws-codepipeline';\nimport * as ecr from '../../../aws-ecr';\nimport * as targets from '../../../aws-events-targets';\nimport * as iam from '../../../aws-iam';\nimport { Names } from '../../../core';\nimport { Action } from '../action';\nimport { sourceArtifactBounds } from '../common';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { Construct } from 'constructs';\n\n/**\n * The CodePipeline variables emitted by the ECR source Action.\n */\nexport interface EcrSourceVariables {\n  /** The identifier of the registry. In ECR, this is usually the ID of the AWS account owning it. */\n  readonly registryId: string;\n\n  /** The physical name of the repository that this action tracks. */\n  readonly repositoryName: string;\n\n  /** The digest of the current image, in the form '<digest type>:<digest value>'. */\n  readonly imageDigest: string;\n\n  /** The Docker tag of the current image. */\n  readonly imageTag: string;\n\n  /** The full ECR Docker URI of the current image. */\n  readonly imageUri: string;\n}\n\n/**\n * Construction properties of {@link EcrSourceAction}.\n */\nexport interface EcrSourceActionProps extends codepipeline.CommonAwsActionProps {\n  /**\n   * The image tag that will be checked for changes.\n   * Provide an empty string to trigger on changes to any tag.\n   *\n   * @default 'latest'\n   */\n  readonly imageTag?: string;\n\n  /**\n   *\n   */\n  readonly output: codepipeline.Artifact;\n\n  /**\n   * The repository that will be watched for changes.\n   */\n  readonly repository: ecr.IRepository;\n}\n\n/**\n * The ECR Repository source CodePipeline Action.\n *\n * Will trigger the pipeline as soon as the target tag in the repository\n * changes, but only if there is a CloudTrail Trail in the account that\n * captures the ECR event.\n */\nexport class EcrSourceAction extends Action {\n  private readonly props: EcrSourceActionProps;\n\n  constructor(props: EcrSourceActionProps) {\n    super({\n      ...props,\n      resource: props.repository,\n      category: codepipeline.ActionCategory.SOURCE,\n      provider: 'ECR',\n      artifactBounds: sourceArtifactBounds(),\n      outputs: [props.output],\n    });\n\n    this.props = props;\n  }\n\n  /** The variables emitted by this action. */\n  public get variables(): EcrSourceVariables {\n    return {\n      registryId: this.variableExpression('RegistryId'),\n      repositoryName: this.variableExpression('RepositoryName'),\n      imageDigest: this.variableExpression('ImageDigest'),\n      imageTag: this.variableExpression('ImageTag'),\n      imageUri: this.variableExpression('ImageURI'),\n    };\n  }\n\n  protected bound(_scope: Construct, stage: codepipeline.IStage, options: codepipeline.ActionBindOptions):\n  codepipeline.ActionConfig {\n    options.role.addToPolicy(new iam.PolicyStatement({\n      actions: ['ecr:DescribeImages'],\n      resources: [this.props.repository.repositoryArn],\n    }));\n\n    this.props.repository.onCloudTrailImagePushed(Names.nodeUniqueId(stage.pipeline.node) + 'SourceEventRule', {\n      target: new targets.CodePipeline(stage.pipeline),\n      imageTag: this.props.imageTag === '' ? undefined : (this.props.imageTag ?? 'latest'),\n    });\n\n    // the Action Role also needs to write to the Pipeline's bucket\n    options.bucket.grantWrite(options.role);\n\n    return {\n      configuration: {\n        RepositoryName: this.props.repository.repositoryName,\n        ImageTag: this.props.imageTag ? this.props.imageTag : undefined, // `''` is falsy in JS/TS\n      },\n    };\n  }\n}\n"],
  "mappings": "yNAAA,aAAA,QAAA,2BAAA,EAEA,QAAA,QAAA,6BAAA,EACA,IAAA,QAAA,kBAAA,EACA,OAAA,QAAA,eAAA,EACA,SAAA,QAAA,WAAA,EACA,SAAA,QAAA,WAAA,EAwDA,MAAa,uBAAwB,UAAA,MAAM,CAGzC,YAAY,MAA2B,CACrC,MAAM,IACD,MACH,SAAU,MAAM,WAChB,SAAU,aAAa,eAAe,OACtC,SAAU,MACV,eAAgB,SAAA,qBAAoB,EACpC,QAAS,CAAC,MAAM,MAAM,EACvB,2FAED,KAAK,MAAQ,SAIJ,YAAS,CAClB,MAAO,CACL,WAAY,KAAK,mBAAmB,YAAY,EAChD,eAAgB,KAAK,mBAAmB,gBAAgB,EACxD,YAAa,KAAK,mBAAmB,aAAa,EAClD,SAAU,KAAK,mBAAmB,UAAU,EAC5C,SAAU,KAAK,mBAAmB,UAAU,GAItC,MAAM,OAAmB,MAA4B,QAAuC,kKAEpG,QAAQ,KAAK,YAAY,GAAI,KAAI,gBAAgB,CAC/C,QAAS,CAAC,oBAAoB,EAC9B,UAAW,CAAC,KAAK,MAAM,WAAW,aAAa,EAChD,CAAC,EAEF,KAAK,MAAM,WAAW,wBAAwB,OAAA,MAAM,aAAa,MAAM,SAAS,IAAI,EAAI,kBAAmB,CACzG,OAAQ,GAAI,SAAQ,aAAa,MAAM,QAAQ,EAC/C,SAAU,KAAK,MAAM,WAAa,GAAK,OAAY,IAAC,KAAK,MAAM,YAAQ,MAAA,KAAA,OAAA,GAAI,SAC5E,EAGD,QAAQ,OAAO,WAAW,QAAQ,IAAI,EAE/B,CACL,cAAe,CACb,eAAgB,KAAK,MAAM,WAAW,eACtC,SAAU,KAAK,MAAM,SAAW,KAAK,MAAM,SAAW,UA7C9D,QAAA,gBAAA",
  "names": []
}
