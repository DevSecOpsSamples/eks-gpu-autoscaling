{
  "version": 3,
  "sources": ["integ.instance.lit.ts"],
  "sourcesContent": ["/// !cdk-integ pragma:ignore-assets\nimport * as cloudwatch from '../../aws-cloudwatch';\nimport * as ec2 from '../../aws-ec2';\nimport * as targets from '../../aws-events-targets';\nimport * as lambda from '../../aws-lambda';\nimport * as logs from '../../aws-logs';\nimport * as cdk from '../../core';\nimport { RemovalPolicy } from '../../core';\nimport * as rds from '../lib';\n\nconst app = new cdk.App();\n\nclass DatabaseInstanceStack extends cdk.Stack {\n  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {\n    super(scope, id, props);\n\n    const vpc = new ec2.Vpc(this, 'VPC', { maxAzs: 2 });\n\n    /// !show\n    // Set open cursors with parameter group\n    const parameterGroup = new rds.ParameterGroup(this, 'ParameterGroup', {\n      engine: rds.DatabaseInstanceEngine.oracleSe2({ version: rds.OracleEngineVersion.VER_19_0_0_0_2020_04_R1 }),\n      parameters: {\n        open_cursors: '2500',\n      },\n    });\n\n    /// Add XMLDB and OEM with option group\n    const optionGroup = new rds.OptionGroup(this, 'OptionGroup', {\n      engine: rds.DatabaseInstanceEngine.oracleSe2({ version: rds.OracleEngineVersion.VER_19_0_0_0_2020_04_R1 }),\n      configurations: [\n        {\n          name: 'LOCATOR',\n        },\n        {\n          name: 'OEM',\n          port: 1158,\n          vpc,\n        },\n      ],\n    });\n\n    // Allow connections to OEM\n    optionGroup.optionConnections.OEM.connections.allowDefaultPortFromAnyIpv4();\n\n    // Database instance with production values\n    const instance = new rds.DatabaseInstance(this, 'Instance', {\n      engine: rds.DatabaseInstanceEngine.oracleSe2({ version: rds.OracleEngineVersion.VER_19_0_0_0_2020_04_R1 }),\n      licenseModel: rds.LicenseModel.BRING_YOUR_OWN_LICENSE,\n      instanceType: ec2.InstanceType.of(ec2.InstanceClass.BURSTABLE3, ec2.InstanceSize.MEDIUM),\n      multiAz: true,\n      storageType: rds.StorageType.IO1,\n      credentials: rds.Credentials.fromUsername('syscdk'),\n      vpc,\n      databaseName: 'ORCL',\n      storageEncrypted: true,\n      backupRetention: cdk.Duration.days(7),\n      monitoringInterval: cdk.Duration.seconds(60),\n      enablePerformanceInsights: true,\n      cloudwatchLogsExports: [\n        'trace',\n        'audit',\n        'alert',\n        'listener',\n      ],\n      cloudwatchLogsRetention: logs.RetentionDays.ONE_MONTH,\n      autoMinorVersionUpgrade: true, // required to be true if LOCATOR is used in the option group\n      optionGroup,\n      parameterGroup,\n      removalPolicy: RemovalPolicy.DESTROY,\n    });\n\n    // Allow connections on default port from any IPV4\n    instance.connections.allowDefaultPortFromAnyIpv4();\n\n    // Rotate the master user password every 30 days\n    instance.addRotationSingleUser();\n\n    // Add alarm for high CPU\n    new cloudwatch.Alarm(this, 'HighCPU', {\n      metric: instance.metricCPUUtilization(),\n      threshold: 90,\n      evaluationPeriods: 1,\n    });\n\n    // Trigger Lambda function on instance availability events\n    const fn = new lambda.Function(this, 'Function', {\n      code: lambda.Code.fromInline('exports.handler = (event) => console.log(event);'),\n      handler: 'index.handler',\n      runtime: lambda.Runtime.NODEJS_12_X,\n    });\n\n    const availabilityRule = instance.onEvent('Availability', { target: new targets.LambdaFunction(fn) });\n    availabilityRule.addEventPattern({\n      detail: {\n        EventCategories: [\n          'availability',\n        ],\n      },\n    });\n    /// !hide\n  }\n}\n\nnew DatabaseInstanceStack(app, 'aws-cdk-rds-instance');\napp.synth();\n"],
  "mappings": "oEACA,KAAA,YAAA,QAAA,sBAAA,EACA,IAAA,QAAA,eAAA,EACA,QAAA,QAAA,0BAAA,EACA,OAAA,QAAA,kBAAA,EACA,KAAA,QAAA,gBAAA,EACA,IAAA,QAAA,YAAA,EACA,OAAA,QAAA,YAAA,EACA,IAAA,QAAA,QAAA,EAEM,IAAM,GAAI,KAAI,IAEpB,MAAM,6BAA8B,KAAI,KAAK,CAC3C,YAAY,MAAgB,GAAY,MAAsB,CAC5D,MAAM,MAAO,GAAI,KAAK,EAEtB,KAAM,KAAM,GAAI,KAAI,IAAI,KAAM,MAAO,CAAE,OAAQ,CAAC,CAAE,EAI5C,eAAiB,GAAI,KAAI,eAAe,KAAM,iBAAkB,CACpE,OAAQ,IAAI,uBAAuB,UAAU,CAAE,QAAS,IAAI,oBAAoB,uBAAuB,CAAE,EACzG,WAAY,CACV,aAAc,QAEjB,EAGK,YAAc,GAAI,KAAI,YAAY,KAAM,cAAe,CAC3D,OAAQ,IAAI,uBAAuB,UAAU,CAAE,QAAS,IAAI,oBAAoB,uBAAuB,CAAE,EACzG,eAAgB,CACd,CACE,KAAM,WAER,CACE,KAAM,MACN,KAAM,KACN,MAGL,EAGD,YAAY,kBAAkB,IAAI,YAAY,4BAA2B,EAGzE,KAAM,UAAW,GAAI,KAAI,iBAAiB,KAAM,WAAY,CAC1D,OAAQ,IAAI,uBAAuB,UAAU,CAAE,QAAS,IAAI,oBAAoB,uBAAuB,CAAE,EACzG,aAAc,IAAI,aAAa,uBAC/B,aAAc,IAAI,aAAa,GAAG,IAAI,cAAc,WAAY,IAAI,aAAa,MAAM,EACvF,QAAS,GACT,YAAa,IAAI,YAAY,IAC7B,YAAa,IAAI,YAAY,aAAa,QAAQ,EAClD,IACA,aAAc,OACd,iBAAkB,GAClB,gBAAiB,IAAI,SAAS,KAAK,CAAC,EACpC,mBAAoB,IAAI,SAAS,QAAQ,EAAE,EAC3C,0BAA2B,GAC3B,sBAAuB,CACrB,QACA,QACA,QACA,YAEF,wBAAyB,KAAK,cAAc,UAC5C,wBAAyB,GACzB,YACA,eACA,cAAe,OAAA,cAAc,QAC9B,EAGD,SAAS,YAAY,4BAA2B,EAGhD,SAAS,sBAAqB,EAG9B,GAAI,YAAW,MAAM,KAAM,UAAW,CACpC,OAAQ,SAAS,qBAAoB,EACrC,UAAW,GACX,kBAAmB,EACpB,EAGD,KAAM,IAAK,GAAI,QAAO,SAAS,KAAM,WAAY,CAC/C,KAAM,OAAO,KAAK,WAAW,kDAAkD,EAC/E,QAAS,gBACT,QAAS,OAAO,QAAQ,YACzB,EAGD,AADyB,SAAS,QAAQ,eAAgB,CAAE,OAAQ,GAAI,SAAQ,eAAe,EAAE,CAAC,CAAE,EACnF,gBAAgB,CAC/B,OAAQ,CACN,gBAAiB,CACf,iBAGL,GAKL,GAAI,uBAAsB,IAAK,sBAAsB,EACrD,IAAI,MAAK",
  "names": []
}
