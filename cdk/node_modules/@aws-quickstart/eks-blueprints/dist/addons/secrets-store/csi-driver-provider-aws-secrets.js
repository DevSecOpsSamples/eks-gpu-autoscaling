"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecretProviderClass = exports.KubernetesSecretType = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const assert = require("assert");
const __1 = require("../..");
var AwsSecretType;
(function (AwsSecretType) {
    AwsSecretType["SSMPARAMETER"] = "ssmparameter";
    AwsSecretType["SECRETSMANAGER"] = "secretsmanager";
})(AwsSecretType || (AwsSecretType = {}));
var KubernetesSecretType;
(function (KubernetesSecretType) {
    KubernetesSecretType["OPAQUE"] = "Opaque";
    KubernetesSecretType["BASIC_AUTH"] = "kubernetes.io/basic-auth";
    KubernetesSecretType["TOKEN"] = "bootstrap.kubernetes.io/token";
    KubernetesSecretType["DOCKER_CONFIG_JSON"] = "kubernetes.io/dockerconfigjson";
    KubernetesSecretType["DOCKER_CONFIG"] = "kubernetes.io/dockercfg";
    KubernetesSecretType["SSH_AUTH"] = "kubernetes.io/ssh-auth";
    KubernetesSecretType["SERVICE_ACCOUNT_TOKEN"] = "kubernetes.io/service-account-token";
    KubernetesSecretType["TLS"] = "kubernetes.io/tls";
})(KubernetesSecretType = exports.KubernetesSecretType || (exports.KubernetesSecretType = {}));
function createParameterObject(csiSecret, secretName, secretType) {
    const result = {
        objectName: secretName,
        objectType: secretType,
    };
    if (csiSecret.jmesPath) {
        result.jmesPath = csiSecret.jmesPath;
    }
    return result;
}
class SecretProviderClass {
    constructor(clusterInfo, serviceAccount, secretProviderClassName, ...csiSecrets) {
        this.clusterInfo = clusterInfo;
        this.serviceAccount = serviceAccount;
        this.secretProviderClassName = secretProviderClassName;
        this.parameterObjects = [];
        this.kubernetesSecrets = [];
        this.csiSecrets = csiSecrets;
        this.secretProviderClassPromise = this.setupSecrets();
    }
    addDependent(...constructs) {
        this.secretProviderClassPromise.then(secretProviderClass => {
            constructs.forEach(dependent => dependent.node.addDependency(secretProviderClass));
        });
    }
    /**
     * Optionally returns volume mounts for a pod or helm chart that supports volume mounts.
     */
    getVolumeMounts(volumeName, mountPath) {
        return {
            "volumes": [
                {
                    name: volumeName,
                    csi: {
                        driver: "secrets-store.csi.k8s.io",
                        readOnly: true,
                        volumeAttributes: {
                            secretProviderClass: this.secretProviderClassName
                        }
                    }
                }
            ],
            "volumeMounts": [
                {
                    name: volumeName,
                    mountPath: mountPath !== null && mountPath !== void 0 ? mountPath : "/mnt/secret-store"
                }
            ]
        };
    }
    /**
     * Setup CSI secrets
     * @param clusterInfo
     */
    setupSecrets() {
        const secretsDriverPromise = this.clusterInfo.getScheduledAddOn(__1.SecretsStoreAddOn.name);
        assert(secretsDriverPromise != null, 'SecretsStoreAddOn is required to setup secrets but is not provided in the add-ons.');
        this.addPolicyToServiceAccount();
        // Create and apply SecretProviderClass manifest
        return secretsDriverPromise.then(secretsDriver => this.createSecretProviderClass(secretsDriver));
    }
    /**
     * Creates Service Account for CSI Secrets driver and sets up the IAM Policies
     * needed to access the AWS Secrets
     * @param clusterInfo
     * @param serviceAccount
     */
    addPolicyToServiceAccount() {
        this.csiSecrets.forEach((csiSecret) => {
            var _a, _b;
            const data = [];
            let kubernetesSecret;
            let secretName;
            const secret = csiSecret.secretProvider.provide(this.clusterInfo);
            if (Object.hasOwnProperty.call(secret, 'secretArn')) {
                const secretManagerSecret = secret;
                secretName = secretManagerSecret.secretName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SECRETSMANAGER);
                this.parameterObjects.push(parameterObject);
                secretManagerSecret.grantRead(this.serviceAccount);
            }
            else {
                const ssmSecret = secret;
                secretName = ssmSecret.parameterName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SSMPARAMETER);
                this.parameterObjects.push(parameterObject);
                ssmSecret.grantRead(this.serviceAccount);
            }
            if (csiSecret.kubernetesSecret) {
                if (csiSecret.kubernetesSecret.data) {
                    csiSecret.kubernetesSecret.data.forEach((item) => {
                        var _a, _b;
                        const dataObject = {
                            objectName: (_a = item.objectName) !== null && _a !== void 0 ? _a : secretName,
                            key: (_b = item.key) !== null && _b !== void 0 ? _b : secretName
                        };
                        data.push(dataObject);
                    });
                }
                else {
                    const dataObject = {
                        objectName: secretName,
                        key: secretName
                    };
                    data.push(dataObject);
                }
                kubernetesSecret = {
                    secretName: csiSecret.kubernetesSecret.secretName,
                    type: (_a = csiSecret.kubernetesSecret.type) !== null && _a !== void 0 ? _a : KubernetesSecretType.OPAQUE,
                    labels: (_b = csiSecret.kubernetesSecret.labels) !== null && _b !== void 0 ? _b : undefined,
                    data,
                };
                this.kubernetesSecrets.push(kubernetesSecret);
            }
        });
    }
    /**
     * Create and apply the SecretProviderClass manifest
     * @param clusterInfo
     * @param serviceAccount
     * @param csiDriver
     */
    createSecretProviderClass(csiDriver) {
        const cluster = this.clusterInfo.cluster;
        const secretProviderClass = this.secretProviderClassName;
        const secretProviderClassManifest = cluster.addManifest(secretProviderClass, {
            apiVersion: 'secrets-store.csi.x-k8s.io/v1alpha1',
            kind: 'SecretProviderClass',
            metadata: {
                name: secretProviderClass,
                namespace: this.serviceAccount.serviceAccountNamespace
            },
            spec: {
                provider: 'aws',
                parameters: {
                    objects: JSON.stringify(this.parameterObjects),
                },
                secretObjects: this.kubernetesSecrets
            }
        });
        secretProviderClassManifest.node.addDependency(this.serviceAccount, csiDriver);
        new aws_cdk_lib_1.CfnOutput(cluster.stack, `${this.serviceAccount.serviceAccountName}-secret-provider-class `, {
            value: secretProviderClass
        });
        return secretProviderClassManifest;
    }
}
exports.SecretProviderClass = SecretProviderClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NpLWRyaXZlci1wcm92aWRlci1hd3Mtc2VjcmV0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGRvbnMvc2VjcmV0cy1zdG9yZS9jc2ktZHJpdmVyLXByb3ZpZGVyLWF3cy1zZWNyZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLDZDQUF3QztBQUV4QyxpQ0FBaUM7QUFDakMsNkJBQTBDO0FBd0UxQyxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDZCw4Q0FBNkIsQ0FBQTtJQUM3QixrREFBaUMsQ0FBQTtBQUNyQyxDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFFRCxJQUFZLG9CQVNYO0FBVEQsV0FBWSxvQkFBb0I7SUFDNUIseUNBQWlCLENBQUE7SUFDakIsK0RBQXVDLENBQUE7SUFDdkMsK0RBQXVDLENBQUE7SUFDdkMsNkVBQXFELENBQUE7SUFDckQsaUVBQXlDLENBQUE7SUFDekMsMkRBQW1DLENBQUE7SUFDbkMscUZBQTZELENBQUE7SUFDN0QsaURBQXlCLENBQUE7QUFDN0IsQ0FBQyxFQVRXLG9CQUFvQixHQUFwQiw0QkFBb0IsS0FBcEIsNEJBQW9CLFFBUy9CO0FBUUQsU0FBUyxxQkFBcUIsQ0FBQyxTQUF5QixFQUFFLFVBQWtCLEVBQUUsVUFBeUI7SUFDbkcsTUFBTSxNQUFNLEdBQW9CO1FBQzVCLFVBQVUsRUFBRSxVQUFVO1FBQ3RCLFVBQVUsRUFBRSxVQUFVO0tBQ3pCLENBQUM7SUFDRixJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUU7UUFDcEIsTUFBTSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDO0tBQ3hDO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQUdELE1BQWEsbUJBQW1CO0lBTzVCLFlBQW9CLFdBQXdCLEVBQVUsY0FBOEIsRUFBVSx1QkFBK0IsRUFBRSxHQUFHLFVBQTRCO1FBQTFJLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQVUsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFRO1FBQ3pILElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsMEJBQTBCLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzFELENBQUM7SUFFTSxZQUFZLENBQUMsR0FBRyxVQUF1QjtRQUMxQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUU7WUFDdkQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztRQUN2RixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7T0FFRztJQUNJLGVBQWUsQ0FBQyxVQUFrQixFQUFFLFNBQW1CO1FBQzFELE9BQU87WUFDSCxTQUFTLEVBQUU7Z0JBQ1A7b0JBQ0ksSUFBSSxFQUFFLFVBQVU7b0JBQ2hCLEdBQUcsRUFBRTt3QkFDRCxNQUFNLEVBQUUsMEJBQTBCO3dCQUNsQyxRQUFRLEVBQUUsSUFBSTt3QkFDZCxnQkFBZ0IsRUFBRTs0QkFDZCxtQkFBbUIsRUFBRSxJQUFJLENBQUMsdUJBQXVCO3lCQUNwRDtxQkFDSjtpQkFDSjthQUNKO1lBQ0QsY0FBYyxFQUFFO2dCQUNaO29CQUNJLElBQUksRUFBRSxVQUFVO29CQUNoQixTQUFTLEVBQUUsU0FBUyxhQUFULFNBQVMsY0FBVCxTQUFTLEdBQUksbUJBQW1CO2lCQUM5QzthQUNKO1NBQ0osQ0FBQztJQUNOLENBQUM7SUFFRDs7O09BR0c7SUFDTyxZQUFZO1FBQ2xCLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RixNQUFNLENBQUMsb0JBQW9CLElBQUksSUFBSSxFQUFFLG9GQUFvRixDQUFDLENBQUM7UUFFM0gsSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFFakMsZ0RBQWdEO1FBQ2hELE9BQU8sb0JBQXFCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQzlDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxhQUFjLENBQUMsQ0FDakQsQ0FBQztJQUNOLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLHlCQUF5QjtRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFOztZQUNsQyxNQUFNLElBQUksR0FBaUMsRUFBRSxDQUFDO1lBQzlDLElBQUksZ0JBQWtDLENBQUM7WUFDdkMsSUFBSSxVQUFrQixDQUFDO1lBQ3ZCLE1BQU0sTUFBTSxHQUErQixTQUFTLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFOUYsSUFBSSxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLEVBQUU7Z0JBQ2pELE1BQU0sbUJBQW1CLEdBQUcsTUFBaUIsQ0FBQztnQkFDOUMsVUFBVSxHQUFHLG1CQUFtQixDQUFDLFVBQVUsQ0FBQztnQkFDNUMsTUFBTSxlQUFlLEdBQUcscUJBQXFCLENBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ25HLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQzVDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDdEQ7aUJBQ0k7Z0JBQ0QsTUFBTSxTQUFTLEdBQUcsTUFBMEIsQ0FBQztnQkFDN0MsVUFBVSxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3JDLE1BQU0sZUFBZSxHQUFHLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUNqRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUM1QyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUM1QztZQUVELElBQUksU0FBUyxDQUFDLGdCQUFnQixFQUFFO2dCQUM1QixJQUFJLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUU7b0JBQ2pDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7O3dCQUM3QyxNQUFNLFVBQVUsR0FBK0I7NEJBQzNDLFVBQVUsRUFBRSxNQUFBLElBQUksQ0FBQyxVQUFVLG1DQUFJLFVBQVU7NEJBQ3pDLEdBQUcsRUFBRSxNQUFBLElBQUksQ0FBQyxHQUFHLG1DQUFJLFVBQVU7eUJBQzlCLENBQUM7d0JBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDMUIsQ0FBQyxDQUFDLENBQUM7aUJBQ047cUJBQ0k7b0JBQ0QsTUFBTSxVQUFVLEdBQStCO3dCQUMzQyxVQUFVLEVBQUUsVUFBVTt3QkFDdEIsR0FBRyxFQUFFLFVBQVU7cUJBQ2xCLENBQUM7b0JBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztpQkFDekI7Z0JBQ0QsZ0JBQWdCLEdBQUc7b0JBQ2YsVUFBVSxFQUFFLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVO29CQUNqRCxJQUFJLEVBQUUsTUFBQSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxtQ0FBSSxvQkFBb0IsQ0FBQyxNQUFNO29CQUNwRSxNQUFNLEVBQUUsTUFBQSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxtQ0FBSSxTQUFTO29CQUN0RCxJQUFJO2lCQUNQLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2FBQ2pEO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDTyx5QkFBeUIsQ0FBQyxTQUFvQjtRQUNwRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztRQUN6RCxNQUFNLDJCQUEyQixHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsbUJBQW1CLEVBQUU7WUFDekUsVUFBVSxFQUFFLHFDQUFxQztZQUNqRCxJQUFJLEVBQUUscUJBQXFCO1lBQzNCLFFBQVEsRUFBRTtnQkFDTixJQUFJLEVBQUUsbUJBQW1CO2dCQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyx1QkFBdUI7YUFDekQ7WUFDRCxJQUFJLEVBQUU7Z0JBQ0YsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsVUFBVSxFQUFFO29CQUNSLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztpQkFDakQ7Z0JBQ0QsYUFBYSxFQUFFLElBQUksQ0FBQyxpQkFBaUI7YUFDeEM7U0FDSixDQUFDLENBQUM7UUFFSCwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUMxQyxJQUFJLENBQUMsY0FBYyxFQUNuQixTQUFTLENBQ1osQ0FBQztRQUVGLElBQUksdUJBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IseUJBQXlCLEVBQUU7WUFDN0YsS0FBSyxFQUFFLG1CQUFtQjtTQUM3QixDQUFDLENBQUM7UUFFSCxPQUFPLDJCQUEyQixDQUFDO0lBQ3ZDLENBQUM7Q0FDSjtBQTFKRCxrREEwSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXJ2aWNlQWNjb3VudCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IHsgSVNlY3JldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgeyBJU3RyaW5nUGFyYW1ldGVyIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNzbSc7XG5pbXBvcnQgeyBDZm5PdXRwdXQgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCB7IFNlY3JldHNTdG9yZUFkZE9uIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gJy4uLy4uL3NwaSc7XG5pbXBvcnQgeyBTZWNyZXRQcm92aWRlciB9IGZyb20gJy4vc2VjcmV0LXByb3ZpZGVyJztcblxuLyoqXG4gKiBDc2lTZWNyZXQgUHJvcHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDc2lTZWNyZXRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIHNlY3JldCBwcm92aWRlciB0aGF0IHJldHVybnMgYSByZWZlcmVuY2UgdG8gYW4gU2VjcmV0cyBNYW5hZ2VyIGVudHJ5IG9yIEJsdWVwcmludHMgUGFyYW1ldGVyLlxuICAgICAqL1xuICAgIHNlY3JldFByb3ZpZGVyOiBTZWNyZXRQcm92aWRlcjtcblxuICAgIC8qKlxuICAgICAqIEZvciBzZWNyZXRzIGNvbnRhaW5pbmcgSlNPTiBzdHJ1Y3R1cmUsIGFuIG9wdGlvbmFsIEpNRVMgUGF0aCAoaHR0cHM6Ly9qbWVzcGF0aC5vcmcvKSBvYmplY3QgdG8gZGVjb21wb3NlIGluZGl2aWR1YWwga2V5cyBhcyBzZXBhcmF0ZSBcbiAgICAgKiBzZWNyZXQgb2JqZWN0IGRhdGEuIFxuICAgICAqL1xuICAgIGptZXNQYXRoPzogSm1lc1BhdGhPYmplY3RbXTtcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgc2VjcmV0IGZvciBjYXNlcyB3aGVuIENTSSBzZWNyZXQgc2hvdWxkIGNyZWF0ZSBhIHN0YW5kYXJkIEt1YmVybmV0ZXMgU2VjcmV0IG9iamVjdC5cbiAgICAgKi9cbiAgICBrdWJlcm5ldGVzU2VjcmV0PzogS3ViZXJuZXRlc1NlY3JldDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBKbWVzUGF0aE9iamVjdCB7XG4gICAgb2JqZWN0QWxpYXM6IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmdcbn1cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIGZvciBLdWJlcm5ldGVzIFNlY3JldHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBLdWJlcm5ldGVzU2VjcmV0IHtcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgU2VjcmV0IE5hbWVcbiAgICAgKi9cbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUeXBlIG9mIEt1YmVybmV0ZXMgU2VjcmV0XG4gICAgICovXG4gICAgdHlwZT86IEt1YmVybmV0ZXNTZWNyZXRUeXBlXG5cbiAgICAvKipcbiAgICAgKiBTZWNyZXQgTGFiZWxzXG4gICAgICovXG4gICAgbGFiZWxzPzogVmFsdWVzO1xuXG4gICAgLyoqXG4gICAgICogS3ViZXJuZXRlcyBTZWNyZXRPYmplY3QgRGF0YVxuICAgICAqL1xuICAgIGRhdGE/OiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YVtdO1xufVxuXG4vKipcbiAqIERhdGEgZm9yIEt1YmVybmV0ZXMgU2VjcmV0c1xuICovXG5pbnRlcmZhY2UgS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEge1xuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgQVdTIFNlY3JldCB0aGF0IGlzIHN5bmNkXG4gICAgICovXG4gICAgb2JqZWN0TmFtZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgU2VjcmV0IEtleVxuICAgICAqL1xuICAgIGtleT86IHN0cmluZztcbn1cblxuZW51bSBBd3NTZWNyZXRUeXBlIHtcbiAgICBTU01QQVJBTUVURVIgPSAnc3NtcGFyYW1ldGVyJyxcbiAgICBTRUNSRVRTTUFOQUdFUiA9ICdzZWNyZXRzbWFuYWdlcidcbn1cblxuZXhwb3J0IGVudW0gS3ViZXJuZXRlc1NlY3JldFR5cGUge1xuICAgIE9QQVFVRSA9ICdPcGFxdWUnLFxuICAgIEJBU0lDX0FVVEggPSAna3ViZXJuZXRlcy5pby9iYXNpYy1hdXRoJyxcbiAgICBUT0tFTiA9ICdib290c3RyYXAua3ViZXJuZXRlcy5pby90b2tlbicsXG4gICAgRE9DS0VSX0NPTkZJR19KU09OID0gJ2t1YmVybmV0ZXMuaW8vZG9ja2VyY29uZmlnanNvbicsXG4gICAgRE9DS0VSX0NPTkZJRyA9ICdrdWJlcm5ldGVzLmlvL2RvY2tlcmNmZycsXG4gICAgU1NIX0FVVEggPSAna3ViZXJuZXRlcy5pby9zc2gtYXV0aCcsXG4gICAgU0VSVklDRV9BQ0NPVU5UX1RPS0VOID0gJ2t1YmVybmV0ZXMuaW8vc2VydmljZS1hY2NvdW50LXRva2VuJyxcbiAgICBUTFMgPSAna3ViZXJuZXRlcy5pby90bHMnXG59XG5cbmludGVyZmFjZSBQYXJhbWV0ZXJPYmplY3Qge1xuICAgIG9iamVjdE5hbWU6IHN0cmluZztcbiAgICBvYmplY3RUeXBlOiBzdHJpbmc7XG4gICAgam1lc1BhdGg/OiBKbWVzUGF0aE9iamVjdFtdO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQYXJhbWV0ZXJPYmplY3QoY3NpU2VjcmV0OiBDc2lTZWNyZXRQcm9wcywgc2VjcmV0TmFtZTogc3RyaW5nLCBzZWNyZXRUeXBlOiBBd3NTZWNyZXRUeXBlKSB7XG4gICAgY29uc3QgcmVzdWx0OiBQYXJhbWV0ZXJPYmplY3QgPSB7XG4gICAgICAgIG9iamVjdE5hbWU6IHNlY3JldE5hbWUsXG4gICAgICAgIG9iamVjdFR5cGU6IHNlY3JldFR5cGUsXG4gICAgfTtcbiAgICBpZiAoY3NpU2VjcmV0LmptZXNQYXRoKSB7XG4gICAgICAgIHJlc3VsdC5qbWVzUGF0aCA9IGNzaVNlY3JldC5qbWVzUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5leHBvcnQgY2xhc3MgU2VjcmV0UHJvdmlkZXJDbGFzcyB7XG5cbiAgICBwcml2YXRlIHBhcmFtZXRlck9iamVjdHM6IFBhcmFtZXRlck9iamVjdFtdO1xuICAgIHByaXZhdGUga3ViZXJuZXRlc1NlY3JldHM6IEt1YmVybmV0ZXNTZWNyZXRbXTtcbiAgICBwcml2YXRlIGNzaVNlY3JldHM6IENzaVNlY3JldFByb3BzW107XG4gICAgcHJpdmF0ZSBzZWNyZXRQcm92aWRlckNsYXNzUHJvbWlzZTogUHJvbWlzZTxDb25zdHJ1Y3Q+O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIHByaXZhdGUgc2VydmljZUFjY291bnQ6IFNlcnZpY2VBY2NvdW50LCBwcml2YXRlIHNlY3JldFByb3ZpZGVyQ2xhc3NOYW1lOiBzdHJpbmcsIC4uLmNzaVNlY3JldHM6IENzaVNlY3JldFByb3BzW10pIHtcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJPYmplY3RzID0gW107XG4gICAgICAgIHRoaXMua3ViZXJuZXRlc1NlY3JldHMgPSBbXTtcbiAgICAgICAgdGhpcy5jc2lTZWNyZXRzID0gY3NpU2VjcmV0cztcbiAgICAgICAgdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzUHJvbWlzZSA9IHRoaXMuc2V0dXBTZWNyZXRzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZERlcGVuZGVudCguLi5jb25zdHJ1Y3RzOiBDb25zdHJ1Y3RbXSkge1xuICAgICAgICB0aGlzLnNlY3JldFByb3ZpZGVyQ2xhc3NQcm9taXNlLnRoZW4oc2VjcmV0UHJvdmlkZXJDbGFzcyA9PiB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RzLmZvckVhY2goZGVwZW5kZW50ID0+IGRlcGVuZGVudC5ub2RlLmFkZERlcGVuZGVuY3koc2VjcmV0UHJvdmlkZXJDbGFzcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbGx5IHJldHVybnMgdm9sdW1lIG1vdW50cyBmb3IgYSBwb2Qgb3IgaGVsbSBjaGFydCB0aGF0IHN1cHBvcnRzIHZvbHVtZSBtb3VudHMuXG4gICAgICovXG4gICAgcHVibGljIGdldFZvbHVtZU1vdW50cyh2b2x1bWVOYW1lOiBzdHJpbmcsIG1vdW50UGF0aD8gOiBzdHJpbmcpOiBWYWx1ZXMge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJ2b2x1bWVzXCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZvbHVtZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGNzaToge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyOiBcInNlY3JldHMtc3RvcmUuY3NpLms4cy5pb1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVhZE9ubHk6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjcmV0UHJvdmlkZXJDbGFzczogdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFwidm9sdW1lTW91bnRzXCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZvbHVtZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIG1vdW50UGF0aDogbW91bnRQYXRoID8/IFwiL21udC9zZWNyZXQtc3RvcmVcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXR1cCBDU0kgc2VjcmV0c1xuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mbyBcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgc2V0dXBTZWNyZXRzKCk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGNvbnN0IHNlY3JldHNEcml2ZXJQcm9taXNlID0gdGhpcy5jbHVzdGVySW5mby5nZXRTY2hlZHVsZWRBZGRPbihTZWNyZXRzU3RvcmVBZGRPbi5uYW1lKTtcbiAgICAgICAgYXNzZXJ0KHNlY3JldHNEcml2ZXJQcm9taXNlICE9IG51bGwsICdTZWNyZXRzU3RvcmVBZGRPbiBpcyByZXF1aXJlZCB0byBzZXR1cCBzZWNyZXRzIGJ1dCBpcyBub3QgcHJvdmlkZWQgaW4gdGhlIGFkZC1vbnMuJyk7XG5cbiAgICAgICAgdGhpcy5hZGRQb2xpY3lUb1NlcnZpY2VBY2NvdW50KCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGFuZCBhcHBseSBTZWNyZXRQcm92aWRlckNsYXNzIG1hbmlmZXN0XG4gICAgICAgIHJldHVybiBzZWNyZXRzRHJpdmVyUHJvbWlzZSEudGhlbihzZWNyZXRzRHJpdmVyID0+XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVNlY3JldFByb3ZpZGVyQ2xhc3Moc2VjcmV0c0RyaXZlciEpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBTZXJ2aWNlIEFjY291bnQgZm9yIENTSSBTZWNyZXRzIGRyaXZlciBhbmQgc2V0cyB1cCB0aGUgSUFNIFBvbGljaWVzXG4gICAgICogbmVlZGVkIHRvIGFjY2VzcyB0aGUgQVdTIFNlY3JldHNcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm9cbiAgICAgKiBAcGFyYW0gc2VydmljZUFjY291bnRcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWRkUG9saWN5VG9TZXJ2aWNlQWNjb3VudCgpIHtcbiAgICAgICAgdGhpcy5jc2lTZWNyZXRzLmZvckVhY2goKGNzaVNlY3JldCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGF0YTogS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGFbXSA9IFtdO1xuICAgICAgICAgICAgbGV0IGt1YmVybmV0ZXNTZWNyZXQ6IEt1YmVybmV0ZXNTZWNyZXQ7XG4gICAgICAgICAgICBsZXQgc2VjcmV0TmFtZTogc3RyaW5nO1xuICAgICAgICAgICAgY29uc3Qgc2VjcmV0OiBJU2VjcmV0IHwgSVN0cmluZ1BhcmFtZXRlciA9IGNzaVNlY3JldC5zZWNyZXRQcm92aWRlci5wcm92aWRlKHRoaXMuY2x1c3RlckluZm8pO1xuXG4gICAgICAgICAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwoc2VjcmV0LCAnc2VjcmV0QXJuJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWNyZXRNYW5hZ2VyU2VjcmV0ID0gc2VjcmV0IGFzIElTZWNyZXQ7XG4gICAgICAgICAgICAgICAgc2VjcmV0TmFtZSA9IHNlY3JldE1hbmFnZXJTZWNyZXQuc2VjcmV0TmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJPYmplY3QgPSBjcmVhdGVQYXJhbWV0ZXJPYmplY3QoY3NpU2VjcmV0LCBzZWNyZXROYW1lLCBBd3NTZWNyZXRUeXBlLlNFQ1JFVFNNQU5BR0VSKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmFtZXRlck9iamVjdHMucHVzaChwYXJhbWV0ZXJPYmplY3QpO1xuICAgICAgICAgICAgICAgIHNlY3JldE1hbmFnZXJTZWNyZXQuZ3JhbnRSZWFkKHRoaXMuc2VydmljZUFjY291bnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3NtU2VjcmV0ID0gc2VjcmV0IGFzIElTdHJpbmdQYXJhbWV0ZXI7XG4gICAgICAgICAgICAgICAgc2VjcmV0TmFtZSA9IHNzbVNlY3JldC5wYXJhbWV0ZXJOYW1lO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtZXRlck9iamVjdCA9IGNyZWF0ZVBhcmFtZXRlck9iamVjdChjc2lTZWNyZXQsIHNlY3JldE5hbWUsIEF3c1NlY3JldFR5cGUuU1NNUEFSQU1FVEVSKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmFtZXRlck9iamVjdHMucHVzaChwYXJhbWV0ZXJPYmplY3QpO1xuICAgICAgICAgICAgICAgIHNzbVNlY3JldC5ncmFudFJlYWQodGhpcy5zZXJ2aWNlQWNjb3VudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjc2lTZWNyZXQua3ViZXJuZXRlc1NlY3JldCkge1xuICAgICAgICAgICAgICAgIGlmIChjc2lTZWNyZXQua3ViZXJuZXRlc1NlY3JldC5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LmRhdGEuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YU9iamVjdDogS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0TmFtZTogaXRlbS5vYmplY3ROYW1lID8/IHNlY3JldE5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBpdGVtLmtleSA/PyBzZWNyZXROYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKGRhdGFPYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGFPYmplY3Q6IEt1YmVybmV0ZXNTZWNyZXRPYmplY3REYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0TmFtZTogc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogc2VjcmV0TmFtZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goZGF0YU9iamVjdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGt1YmVybmV0ZXNTZWNyZXQgPSB7XG4gICAgICAgICAgICAgICAgICAgIHNlY3JldE5hbWU6IGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LnNlY3JldE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LnR5cGUgPz8gS3ViZXJuZXRlc1NlY3JldFR5cGUuT1BBUVVFLFxuICAgICAgICAgICAgICAgICAgICBsYWJlbHM6IGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LmxhYmVscyA/PyB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLmt1YmVybmV0ZXNTZWNyZXRzLnB1c2goa3ViZXJuZXRlc1NlY3JldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbmQgYXBwbHkgdGhlIFNlY3JldFByb3ZpZGVyQ2xhc3MgbWFuaWZlc3RcbiAgICAgKiBAcGFyYW0gY2x1c3RlckluZm9cbiAgICAgKiBAcGFyYW0gc2VydmljZUFjY291bnRcbiAgICAgKiBAcGFyYW0gY3NpRHJpdmVyXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVNlY3JldFByb3ZpZGVyQ2xhc3MoY3NpRHJpdmVyOiBDb25zdHJ1Y3QpOiBDb25zdHJ1Y3Qge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gdGhpcy5jbHVzdGVySW5mby5jbHVzdGVyO1xuICAgICAgICBjb25zdCBzZWNyZXRQcm92aWRlckNsYXNzID0gdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzTmFtZTtcbiAgICAgICAgY29uc3Qgc2VjcmV0UHJvdmlkZXJDbGFzc01hbmlmZXN0ID0gY2x1c3Rlci5hZGRNYW5pZmVzdChzZWNyZXRQcm92aWRlckNsYXNzLCB7XG4gICAgICAgICAgICBhcGlWZXJzaW9uOiAnc2VjcmV0cy1zdG9yZS5jc2kueC1rOHMuaW8vdjFhbHBoYTEnLFxuICAgICAgICAgICAga2luZDogJ1NlY3JldFByb3ZpZGVyQ2xhc3MnLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBzZWNyZXRQcm92aWRlckNsYXNzLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5zZXJ2aWNlQWNjb3VudC5zZXJ2aWNlQWNjb3VudE5hbWVzcGFjZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNwZWM6IHtcbiAgICAgICAgICAgICAgICBwcm92aWRlcjogJ2F3cycsXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgICAgICBvYmplY3RzOiBKU09OLnN0cmluZ2lmeSh0aGlzLnBhcmFtZXRlck9iamVjdHMpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2VjcmV0T2JqZWN0czogdGhpcy5rdWJlcm5ldGVzU2VjcmV0c1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzZWNyZXRQcm92aWRlckNsYXNzTWFuaWZlc3Qubm9kZS5hZGREZXBlbmRlbmN5KFxuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlQWNjb3VudCxcbiAgICAgICAgICAgIGNzaURyaXZlclxuICAgICAgICApO1xuXG4gICAgICAgIG5ldyBDZm5PdXRwdXQoY2x1c3Rlci5zdGFjaywgYCR7dGhpcy5zZXJ2aWNlQWNjb3VudC5zZXJ2aWNlQWNjb3VudE5hbWV9LXNlY3JldC1wcm92aWRlci1jbGFzcyBgLCB7XG4gICAgICAgICAgICB2YWx1ZTogc2VjcmV0UHJvdmlkZXJDbGFzc1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc2VjcmV0UHJvdmlkZXJDbGFzc01hbmlmZXN0O1xuICAgIH1cbn1cbiJdfQ==