"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationStage = exports.CodePipelineStack = exports.CodePipelineBuilder = exports.cdkpipelines = void 0;
const cdk = require("aws-cdk-lib");
const cdkpipelines = require("aws-cdk-lib/pipelines");
exports.cdkpipelines = cdkpipelines;
const assert = require("assert");
const usage_utils_1 = require("../utils/usage-utils");
/**
 * Builder for CodePipeline.
 */
class CodePipelineBuilder {
    constructor() {
        this.props = { stages: [], waves: [] };
    }
    name(name) {
        this.props.name = name;
        return this;
    }
    owner(owner) {
        this.props.owner = owner;
        return this;
    }
    repository(repo) {
        this.props.repository = repo;
        return this;
    }
    /**
     * Adds standalone pipeline stages (in the order of invocation and elements in the input array)
     * @param stackStages
     * @returns
     */
    stage(...stackStages) {
        stackStages.forEach(stage => this.props.stages.push(stage));
        return this;
    }
    /**
     * Adds wave(s) in the order specified. All stages in the wave can be executed in parallel, while standalone stages are executed sequentially.
     * @param waves
     * @returns
     */
    wave(...waves) {
        waves.forEach(wave => {
            this.props.waves.push(wave);
            wave.stages.forEach(stage => { var _a; return (_a = this.props.stages) === null || _a === void 0 ? void 0 : _a.push({ ...stage, ...{ waveId: wave.id } }); });
        });
        return this;
    }
    build(scope, id, stackProps) {
        assert(this.props.name, "name field is required for the pipeline stack. Please provide value.");
        assert(this.props.owner, "owner field is required for the pipeline stack Please provide value.");
        assert(this.props.stages, "Stage field is required for the pipeline stack. Please provide value.");
        const fullProps = this.props;
        return new CodePipelineStack(scope, fullProps, id, stackProps);
    }
}
exports.CodePipelineBuilder = CodePipelineBuilder;
/**
 * Pipeline stack is generating a self-mutating pipeline to faciliate full CI/CD experience with the platform
 * for infrastructure changes.
 */
class CodePipelineStack extends cdk.Stack {
    constructor(scope, pipelineProps, id, props) {
        super(scope, id, (0, usage_utils_1.withUsageTracking)(CodePipelineStack.USAGE_ID, props));
        const pipeline = CodePipeline.build(this, pipelineProps);
        let promises = [];
        for (let stage of pipelineProps.stages) {
            const appStage = new ApplicationStage(this, stage.id, stage.stackBuilder);
            promises.push(appStage.waitForAsyncTasks());
        }
        Promise.all(promises).then(stages => {
            let currentWave;
            for (let i in stages) {
                const stage = pipelineProps.stages[i];
                if (stage.waveId) {
                    if (currentWave == null || currentWave.id != stage.waveId) {
                        const waveProps = pipelineProps.waves.find(wave => wave.id === stage.waveId);
                        assert(waveProps, `Specified wave ${stage.waveId} is not found in the pipeline definition ${id}`);
                        currentWave = pipeline.addWave(stage.waveId, { ...waveProps.props });
                    }
                    currentWave.addStage(stages[i], stage.stageProps);
                }
                else {
                    pipeline.addStage(stages[i], stage.stageProps);
                }
            }
        });
    }
    static builder() {
        return new CodePipelineBuilder();
    }
}
exports.CodePipelineStack = CodePipelineStack;
CodePipelineStack.USAGE_ID = "qs-1s1r465k6";
class ApplicationStage extends cdk.Stage {
    constructor(scope, id, builder, props) {
        super(scope, id, props);
        if (builder.buildAsync !== undefined) {
            this.asyncTask = builder.buildAsync(this, `${id}-blueprint`, props);
        }
        else {
            builder.build(this, `${id}-blueprint`, props);
        }
    }
    async waitForAsyncTasks() {
        if (this.asyncTask) {
            return this.asyncTask.then(() => {
                return this;
            });
        }
        return Promise.resolve(this);
    }
}
exports.ApplicationStage = ApplicationStage;
/**
 * CodePipeline deploys a new CodePipeline resource that is integrated with a GitHub repository.
 */
class CodePipeline {
    static build(scope, props) {
        var _a;
        const branch = (_a = props.repository.targetRevision) !== null && _a !== void 0 ? _a : 'main';
        let githubProps = undefined;
        if (props.repository.credentialsSecretName) {
            githubProps = {
                authentication: cdk.SecretValue.secretsManager(props.repository.credentialsSecretName)
            };
        }
        return new cdkpipelines.CodePipeline(scope, props.name, {
            pipelineName: props.name,
            synth: new cdkpipelines.ShellStep(`${props.name}-synth`, {
                input: cdkpipelines.CodePipelineSource.gitHub(`${props.owner}/${props.repository.repoUrl}`, branch, githubProps),
                installCommands: [
                    'npm install --global npm',
                    'npm install -g aws-cdk@2.20.0',
                    'npm install',
                ],
                commands: ['npm run build', 'npx cdk synth']
            })
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1waXBlbGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9waXBlbGluZXMvY29kZS1waXBlbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFHbkMsc0RBQXNEO0FBTWxELG9DQUFZO0FBTGhCLGlDQUFpQztBQUVqQyxzREFBeUQ7QUFxR3pEOztHQUVHO0FBQ0gsTUFBYSxtQkFBbUI7SUFLNUI7UUFDSSxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVNLElBQUksQ0FBQyxJQUFZO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUN2QixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQWE7UUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxVQUFVLENBQUMsSUFBNEI7UUFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQzdCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLEdBQUcsV0FBeUI7UUFDckMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQzdELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksSUFBSSxDQUFDLEdBQUcsS0FBcUI7UUFDaEMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQU0s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b0I7O1FBQ3RELE1BQU0sTUFBTSxHQUFHLE1BQUEsS0FBSyxDQUFDLFVBQVUsQ0FBQyxjQUFjLG1DQUFJLE1BQU0sQ0FBQztRQUN6RCxJQUFJLFdBQVcsR0FBa0QsU0FBUyxDQUFDO1FBRTNFLElBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRTtZQUN2QyxXQUFXLEdBQUc7Z0JBQ1YsY0FBYyxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMscUJBQXNCLENBQUM7YUFDMUYsQ0FBQztTQUNMO1FBRUQsT0FBTyxJQUFJLFlBQVksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDcEQsWUFBWSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ3hCLEtBQUssRUFBRSxJQUFJLFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxRQUFRLEVBQUU7Z0JBQ3ZELEtBQUssRUFBRSxZQUFZLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUM7Z0JBQ2hILGVBQWUsRUFBRTtvQkFDZiwwQkFBMEI7b0JBQzFCLCtCQUErQjtvQkFDL0IsYUFBYTtpQkFDZDtnQkFDRCxRQUFRLEVBQUUsQ0FBQyxlQUFlLEVBQUUsZUFBZSxDQUFDO2FBQzdDLENBQUM7U0FDSCxDQUFDLENBQUM7SUFDVCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgU3RhY2tQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGtwaXBlbGluZXMgZnJvbSAnYXdzLWNkay1saWIvcGlwZWxpbmVzJztcbmltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblJlcG9zaXRvcnksIEFzeW5jU3RhY2tCdWlsZGVyLCBTdGFja0J1aWxkZXIgfSBmcm9tICcuLi9zcGknO1xuaW1wb3J0IHsgd2l0aFVzYWdlVHJhY2tpbmcgfSBmcm9tICcuLi91dGlscy91c2FnZS11dGlscyc7XG5cbmV4cG9ydCB7XG4gICAgY2RrcGlwZWxpbmVzXG59O1xuXG4vKipcbiAqIGNyZWRlbnRpYWxzVHlwZSBpcyBleGNsdWRlZCBhbmQgdGhlIG9ubHkgc3VwcG9ydGVkIGNyZWRlbnRpYWxzU2VjcmV0IGlzIGEgcGxhaW50ZXh0IEdpdEh1YiBPQXV0aCB0b2tlbi5cbiAqIHJlcG9VcmwgXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR2l0SHViU291cmNlUmVwb3NpdG9yeSBleHRlbmRzIE9taXQ8QXBwbGljYXRpb25SZXBvc2l0b3J5LCBcImNyZWRlbnRpYWxzVHlwZVwiPiB7XG4gICAgLyoqXG4gICAgICogQSBHaXRIdWIgT0F1dGggdG9rZW4gdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvbiBzdG9yZWQgd2l0aCBBV1MgU2VjcmV0IE1hbmFnZXIuXG4gICAgICogVGhlIHByb3ZpZGVkIG5hbWUgd2lsbCBiZSBsb29rZWQgdXAgdXNpbmcgdGhlIGZvbGxvd2luZzpcbiAgICAgKiBgYGB0c1xuICAgICAqIGNvbnN0IGNyZWRlbnRpYWxzID0gY2RrLlNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKCdteS1naXRodWItdG9rZW4nKTtcbiAgICAgKiBgYGBcbiAgICAgKlxuICAgICAqIFRoZSBHaXRIdWIgUGVyc29uYWwgQWNjZXNzIFRva2VuIHNob3VsZCBoYXZlIHRoZXNlIHNjb3BlczpcbiAgICAgKlxuICAgICAqICogKipyZXBvKiogLSB0byByZWFkIHRoZSByZXBvc2l0b3J5XG4gICAgICogKiAqKmFkbWluOnJlcG9faG9vayoqIC0gaWYgeW91IHBsYW4gdG8gdXNlIHdlYmhvb2tzICh0cnVlIGJ5IGRlZmF1bHQpXG4gICAgICpcbiAgICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9jb2RlcGlwZWxpbmUvbGF0ZXN0L3VzZXJndWlkZS9HaXRIdWItY3JlYXRlLXBlcnNvbmFsLXRva2VuLUNMSS5odG1sXG4gICAgICovXG4gICAgY3JlZGVudGlhbHNTZWNyZXROYW1lOiBzdHJpbmdcbn1cblxuLyoqXG4gKiBQcm9wcyBmb3IgdGhlIFBpcGVsaW5lLlxuICovXG5leHBvcnQgdHlwZSBQaXBlbGluZVByb3BzID0ge1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIGZvciB0aGUgcGlwZWxpbmUuXG4gICAgICovXG4gICAgbmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG93bmVyIG9mIHRoZSByZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmUgKEdpdEh1YiBoYW5kbGUpLlxuICAgICAqL1xuICAgIG93bmVyOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBSZXBvc2l0b3J5IGZvciB0aGUgcGlwZWxpbmVcbiAgICAgKi9cbiAgICByZXBvc2l0b3J5OiBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5O1xuXG4gICAgLyoqXG4gICAgICogUGlwZWxpbmUgc3RhZ2VzIGFuZCBvcHRpb25zLlxuICAgICAqL1xuICAgIHN0YWdlczogV2F2ZVN0YWdlW107XG5cbiAgICAvKipcbiAgICAgKiBXYXZlcyBmb3IgdGhlIHBpcGVsaW5lLiBTdGFnZXMgaW5zaWRlIHRoZSB3YXZlIGFyZSBleGVjdXRlZCBpbiBwYXJhbGxlbC5cbiAgICAgKi9cbiAgICB3YXZlczogUGlwZWxpbmVXYXZlW107XG59XG5cbi8qKlxuICogU3RhY2sgc3RhZ2UgaXMgYSBidWlsZGVyIGNvbnN0cnVjdCB0byBhbGxvdyBhZGRpbmcgc3RhZ2VzIHRvIGEgcGlwZWxpbmUuIEVhY2ggc3RhZ2UgaXMgZXhwZWN0ZWQgdG8gcHJvZHVjZSBhIHN0YWNrLiBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFja1N0YWdlIHtcbiAgICAvKipcbiAgICAgKiBpZCBvZiB0aGUgc3RhZ2VcbiAgICAgKi9cbiAgICBpZDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQnVpbGRlciB0aGF0IGNhbiBwcm9kdWNlIGEgc3RhY2sgd2hpY2ggd2lsbCBiZSBkZXBsb3llZCBhcyBwYXJ0IG9mIHRoZSBzdGFnZVxuICAgICAqL1xuICAgIHN0YWNrQnVpbGRlcjogU3RhY2tCdWlsZGVyO1xuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWwgc3RhZ2UgcHJvcGVydGllcywgc3VjaCBhcyB7bWFudWFsQXBwcm92YWxzOiB0cnVlfSB3aGljaCBjYW4gY29udHJvbCBzdGFnZSB0cmFuc2l0aW9ucy5cbiAgICAgKi9cbiAgICBzdGFnZVByb3BzPzogY2RrcGlwZWxpbmVzLkFkZFN0YWdlT3B0cztcbn1cblxuLyoqIFxuICogSW50ZXJuYWwgaW50ZXJmYWNlIGZvciB3YXZlIHN0YWdlc1xuICovXG5pbnRlcmZhY2UgV2F2ZVN0YWdlIGV4dGVuZHMgU3RhY2tTdGFnZSB7XG4gICAgLyoqXG4gICAgICogV2F2ZSBpZCBpZiB0aGlzIHN0YWdlIGlzIHBhcnQgb2YgYSB3YXZlLiBOb3QgcmVxdWlyZWQgaWYgc3RhZ2UgaXMgc3VwcGxpZWQgXG4gICAgICovXG4gICAgd2F2ZUlkPzogc3RyaW5nLFxufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgd2F2ZSBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGlwZWxpbmVXYXZlIHtcblxuICAgIGlkOiBzdHJpbmcsIFxuXG4gICAgc3RhZ2VzOiBTdGFja1N0YWdlW10sXG5cbiAgICBwcm9wcz86IGNka3BpcGVsaW5lcy5XYXZlUHJvcHNcbn1cblxuLyoqXG4gKiBCdWlsZGVyIGZvciBDb2RlUGlwZWxpbmUuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb2RlUGlwZWxpbmVCdWlsZGVyIGltcGxlbWVudHMgU3RhY2tCdWlsZGVyIHtcblxuICAgIHByaXZhdGUgcHJvcHM6IFBhcnRpYWw8UGlwZWxpbmVQcm9wcz47XG5cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnByb3BzID0geyBzdGFnZXM6IFtdLCB3YXZlczogW119O1xuICAgIH1cblxuICAgIHB1YmxpYyBuYW1lKG5hbWU6IHN0cmluZyk6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB0aGlzLnByb3BzLm5hbWUgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgb3duZXIob3duZXI6IHN0cmluZykgOiBDb2RlUGlwZWxpbmVCdWlsZGVyIHtcbiAgICAgICAgdGhpcy5wcm9wcy5vd25lciA9IG93bmVyO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVwb3NpdG9yeShyZXBvOiBHaXRIdWJTb3VyY2VSZXBvc2l0b3J5KTogQ29kZVBpcGVsaW5lQnVpbGRlciB7XG4gICAgICAgIHRoaXMucHJvcHMucmVwb3NpdG9yeSA9IHJlcG87XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgc3RhbmRhbG9uZSBwaXBlbGluZSBzdGFnZXMgKGluIHRoZSBvcmRlciBvZiBpbnZvY2F0aW9uIGFuZCBlbGVtZW50cyBpbiB0aGUgaW5wdXQgYXJyYXkpXG4gICAgICogQHBhcmFtIHN0YWNrU3RhZ2VzIFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGFnZSguLi5zdGFja1N0YWdlczogU3RhY2tTdGFnZVtdKSA6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICBzdGFja1N0YWdlcy5mb3JFYWNoKHN0YWdlID0+IHRoaXMucHJvcHMuc3RhZ2VzIS5wdXNoKHN0YWdlKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgd2F2ZShzKSBpbiB0aGUgb3JkZXIgc3BlY2lmaWVkLiBBbGwgc3RhZ2VzIGluIHRoZSB3YXZlIGNhbiBiZSBleGVjdXRlZCBpbiBwYXJhbGxlbCwgd2hpbGUgc3RhbmRhbG9uZSBzdGFnZXMgYXJlIGV4ZWN1dGVkIHNlcXVlbnRpYWxseS5cbiAgICAgKiBAcGFyYW0gd2F2ZXMgXG4gICAgICogQHJldHVybnMgXG4gICAgICovXG4gICAgcHVibGljIHdhdmUoLi4ud2F2ZXM6IFBpcGVsaW5lV2F2ZVtdKSA6IENvZGVQaXBlbGluZUJ1aWxkZXIge1xuICAgICAgICB3YXZlcy5mb3JFYWNoKHdhdmUgPT4geyBcbiAgICAgICAgICAgIHRoaXMucHJvcHMud2F2ZXMhLnB1c2god2F2ZSk7XG4gICAgICAgICAgICB3YXZlLnN0YWdlcy5mb3JFYWNoKHN0YWdlID0+IHRoaXMucHJvcHMuc3RhZ2VzPy5wdXNoKHsuLi5zdGFnZSwgLi4ueyB3YXZlSWQ6IHdhdmUuaWR9fSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIFxuICAgIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHN0YWNrUHJvcHM/OiBjZGsuU3RhY2tQcm9wcyk6IGNkay5TdGFjayB7XG4gICAgICAgIGFzc2VydCh0aGlzLnByb3BzLm5hbWUsIFwibmFtZSBmaWVsZCBpcyByZXF1aXJlZCBmb3IgdGhlIHBpcGVsaW5lIHN0YWNrLiBQbGVhc2UgcHJvdmlkZSB2YWx1ZS5cIik7XG4gICAgICAgIGFzc2VydCh0aGlzLnByb3BzLm93bmVyLFwib3duZXIgZmllbGQgaXMgcmVxdWlyZWQgZm9yIHRoZSBwaXBlbGluZSBzdGFjayBQbGVhc2UgcHJvdmlkZSB2YWx1ZS5cIik7XG4gICAgICAgIGFzc2VydCh0aGlzLnByb3BzLnN0YWdlcywgXCJTdGFnZSBmaWVsZCBpcyByZXF1aXJlZCBmb3IgdGhlIHBpcGVsaW5lIHN0YWNrLiBQbGVhc2UgcHJvdmlkZSB2YWx1ZS5cIik7XG4gICAgICAgIGNvbnN0IGZ1bGxQcm9wcyA9IHRoaXMucHJvcHMgYXMgUGlwZWxpbmVQcm9wcztcbiAgICAgICAgcmV0dXJuIG5ldyBDb2RlUGlwZWxpbmVTdGFjayhzY29wZSwgZnVsbFByb3BzLCBpZCwgc3RhY2tQcm9wcyk7XG4gICAgfVxufVxuXG5cbi8qKlxuICogUGlwZWxpbmUgc3RhY2sgaXMgZ2VuZXJhdGluZyBhIHNlbGYtbXV0YXRpbmcgcGlwZWxpbmUgdG8gZmFjaWxpYXRlIGZ1bGwgQ0kvQ0QgZXhwZXJpZW5jZSB3aXRoIHRoZSBwbGF0Zm9ybSBcbiAqIGZvciBpbmZyYXN0cnVjdHVyZSBjaGFuZ2VzLlxuICovXG5leHBvcnQgY2xhc3MgQ29kZVBpcGVsaW5lU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuXG4gICAgc3RhdGljIHJlYWRvbmx5IFVTQUdFX0lEID0gXCJxcy0xczFyNDY1azZcIjtcblxuICAgIHN0YXRpYyBidWlsZGVyKCkge1xuICAgICAgICByZXR1cm4gbmV3IENvZGVQaXBlbGluZUJ1aWxkZXIoKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBwaXBlbGluZVByb3BzOiBQaXBlbGluZVByb3BzLCBpZDogc3RyaW5nLCAgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCwgd2l0aFVzYWdlVHJhY2tpbmcoQ29kZVBpcGVsaW5lU3RhY2suVVNBR0VfSUQsIHByb3BzKSk7XG4gICAgICAgIGNvbnN0IHBpcGVsaW5lICA9IENvZGVQaXBlbGluZS5idWlsZCh0aGlzLCBwaXBlbGluZVByb3BzKTtcblxuICAgICAgICBsZXQgcHJvbWlzZXMgOiBQcm9taXNlPEFwcGxpY2F0aW9uU3RhZ2U+W10gPSBbXTtcblxuICAgICAgICBmb3IobGV0IHN0YWdlIG9mIHBpcGVsaW5lUHJvcHMuc3RhZ2VzKSB7XG4gICAgICAgICAgICBjb25zdCBhcHBTdGFnZSA9IG5ldyBBcHBsaWNhdGlvblN0YWdlKHRoaXMsIHN0YWdlLmlkLCBzdGFnZS5zdGFja0J1aWxkZXIpO1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChhcHBTdGFnZS53YWl0Rm9yQXN5bmNUYXNrcygpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKHN0YWdlcyA9PiB7XG4gICAgICAgICAgICBsZXQgY3VycmVudFdhdmUgOiBjZGtwaXBlbGluZXMuV2F2ZSB8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yKGxldCBpIGluIHN0YWdlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YWdlID0gcGlwZWxpbmVQcm9wcy5zdGFnZXNbaV07XG4gICAgICAgICAgICAgICAgaWYoc3RhZ2Uud2F2ZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRXYXZlID09IG51bGwgfHwgY3VycmVudFdhdmUuaWQgIT0gc3RhZ2Uud2F2ZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXZlUHJvcHMgPSBwaXBlbGluZVByb3BzLndhdmVzLmZpbmQod2F2ZSA9PiB3YXZlLmlkID09PSBzdGFnZS53YXZlSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KHdhdmVQcm9wcywgYFNwZWNpZmllZCB3YXZlICR7c3RhZ2Uud2F2ZUlkfSBpcyBub3QgZm91bmQgaW4gdGhlIHBpcGVsaW5lIGRlZmluaXRpb24gJHtpZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRXYXZlID0gcGlwZWxpbmUuYWRkV2F2ZShzdGFnZS53YXZlSWQsIHsgLi4ud2F2ZVByb3BzLnByb3BzIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRXYXZlLmFkZFN0YWdlKHN0YWdlc1tpXSwgc3RhZ2Uuc3RhZ2VQcm9wcyk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmUuYWRkU3RhZ2Uoc3RhZ2VzW2ldLCBzdGFnZS5zdGFnZVByb3BzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25TdGFnZSBleHRlbmRzIGNkay5TdGFnZSB7XG5cbiAgICBwcml2YXRlIGFzeW5jVGFzazogUHJvbWlzZTxhbnk+O1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5TdGFjaywgaWQ6IHN0cmluZywgYnVpbGRlcjogU3RhY2tCdWlsZGVyIHwgQXN5bmNTdGFja0J1aWxkZXIsIHByb3BzPzogY2RrLlN0YWdlUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgICAgIGlmKCg8QXN5bmNTdGFja0J1aWxkZXI+YnVpbGRlcikuYnVpbGRBc3luYyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmFzeW5jVGFzayA9ICg8QXN5bmNTdGFja0J1aWxkZXI+YnVpbGRlcikuYnVpbGRBc3luYyh0aGlzLCBgJHtpZH0tYmx1ZXByaW50YCwgcHJvcHMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYnVpbGRlci5idWlsZCh0aGlzLCBgJHtpZH0tYmx1ZXByaW50YCwgcHJvcHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHdhaXRGb3JBc3luY1Rhc2tzKCkgOiBQcm9taXNlPEFwcGxpY2F0aW9uU3RhZ2U+IHtcbiAgICAgICAgaWYodGhpcy5hc3luY1Rhc2spIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFzeW5jVGFzay50aGVuKCgpPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzKTtcbiAgICB9XG59XG5cbi8qKlxuICogQ29kZVBpcGVsaW5lIGRlcGxveXMgYSBuZXcgQ29kZVBpcGVsaW5lIHJlc291cmNlIHRoYXQgaXMgaW50ZWdyYXRlZCB3aXRoIGEgR2l0SHViIHJlcG9zaXRvcnkuXG4gKi9cbmNsYXNzIENvZGVQaXBlbGluZSB7XG5cbiAgICBwdWJsaWMgc3RhdGljIGJ1aWxkKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBQaXBlbGluZVByb3BzKSA6IGNka3BpcGVsaW5lcy5Db2RlUGlwZWxpbmUge1xuICAgICAgICBjb25zdCBicmFuY2ggPSBwcm9wcy5yZXBvc2l0b3J5LnRhcmdldFJldmlzaW9uID8/ICdtYWluJztcbiAgICAgICAgbGV0IGdpdGh1YlByb3BzIDogY2RrcGlwZWxpbmVzLkdpdEh1YlNvdXJjZU9wdGlvbnMgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgaWYocHJvcHMucmVwb3NpdG9yeS5jcmVkZW50aWFsc1NlY3JldE5hbWUpIHtcbiAgICAgICAgICAgIGdpdGh1YlByb3BzID0ge1xuICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uOiBjZGsuU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIocHJvcHMucmVwb3NpdG9yeS5jcmVkZW50aWFsc1NlY3JldE5hbWUhKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZShzY29wZSwgcHJvcHMubmFtZSwge1xuICAgICAgICAgICAgcGlwZWxpbmVOYW1lOiBwcm9wcy5uYW1lLFxuICAgICAgICAgICAgc3ludGg6IG5ldyBjZGtwaXBlbGluZXMuU2hlbGxTdGVwKGAke3Byb3BzLm5hbWV9LXN5bnRoYCwge1xuICAgICAgICAgICAgICBpbnB1dDogY2RrcGlwZWxpbmVzLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoYCR7cHJvcHMub3duZXJ9LyR7cHJvcHMucmVwb3NpdG9yeS5yZXBvVXJsfWAsIGJyYW5jaCwgZ2l0aHViUHJvcHMpLCBcbiAgICAgICAgICAgICAgaW5zdGFsbENvbW1hbmRzOiBbXG4gICAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsIC0tZ2xvYmFsIG5wbScsXG4gICAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsIC1nIGF3cy1jZGtAMi4yMC4wJyxcbiAgICAgICAgICAgICAgICAnbnBtIGluc3RhbGwnLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICBjb21tYW5kczogWyducG0gcnVuIGJ1aWxkJywgJ25weCBjZGsgc3ludGgnXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=